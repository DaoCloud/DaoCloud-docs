# 基本概念

本文介绍微服务相关的基础知识。

## 微服务

微服务是一种通过多个小型服务组合来构建单个应用的架构风格，这些服务围绕业务能力而非特定的技术标准来构建。各个服务可以采用不同的编程语言，不同的数据存储技术，运行在不同的进程之中。服务采取轻量级的通信机制（通常是基于 HTTP 的 RESTful API 和 RPC 协议）和自动化的部署机制实现通信与运维。微服务具有技术异构、故障隔离、敏捷开发、独立部署，弹性扩缩、代码可复用等优势。

- ### 传统微服务

  传统微服务指基于传统的微服务注册中心发展而来的微服务治理模式和技术体系。传统的微服务框架主要有 Spring Cloud、Dubbo 等，传统的注册中心主要有 Eureka、Nacos、Zookeeper、Consul、etcd 等。

- ### 云原生微服务

  云原生微服务指基于 Kubernetes 发展而来的跨技术栈微服务治理模式，自无框架以来逐步向服务网格发展。这种模式使用云原生的框架（如 Kubernetes、Istio、Linkered），云原生的注册中心（如 Kubernetes 注册中心和 Mesh 注册中心）和云原生的网关（如 Nginx、Envoy、Contour）。

## 微服务引擎

微服务引擎（Microservices Engine）可以说是一种微服务治理模式的核心，可以提供服务注册、服务治理（限流、熔断、超时、重试、可观测性等）、网关管理、配置管理等功能。

## 服务网格

服务网格 (Service Mesh) 是在网络层 TCP/IP 上建立的一个中间层，接管服务之间的通信流量，将微服务治理能力下沉，从而实现对上层应用透明、不限制语言、无侵入的享受微服务能力。使用服务网格时，通过还会在应用服务旁边注入一个 SideCar 代理，实现对服务网络流量的拦截。

## 云原生网关

网关是介于客户端和服务器端之间的中间层，所有的外部请求都需要经过网关层。而云原生网关指的是基于云原生可声明式 API 概念发展而来的、与业务解耦的网关，例如 Zuul、Kong、Nginx、Spring Cloud Gateway、Envoy 等。云原生网关最显著的特点是，可以通过声明的方式定义网关的运行时配置，可以通过控制面的声明自动生成配置。云原生网关的功能和微服务网关基本类似，例如身份验证、路由、监控、负载均衡、缓存、服务升降级、静态响应处理、流量控制、日志、重试、熔断等。

## 微服务框架

微服务框架可以分为侵入式和非侵入式两种。侵入式框架以 Spring Cloud 和 Dubbo 为代表，需要对旧代码进行改造。非侵入式框架以 Istio 和 Linkerd 为代表，在原有基础上加入边车和服务网格，无需更改旧代码。

## 注册中心

注册中心相当于微服务架构中的”通讯录“，负责记录服务和服务地址的映射关系。微服务在启动时，将自己的网络地址等信息注册到注册中心，注册中心存储这些数据。服务消费者从注册中心查询服务提供者的地址，并通过该地址调用服务提供者的接口。各个微服务与注册中心使用一定机制通信。如果注册中心与某微服务长时间无法通信，就会注销该实例。如果微服务网络地址发生变化时，会重新注册到注册中心。

## 传统的服务注册与发现

服务注册是指，微服务启动时通过集成的服务发现 SDK 向注册中心发送注册信息，注册中心在收到服务注册请求后将该服务的基本信息存储下来。服务发现是指，在服务注册之后，如有服务消费者要调用该服务，调用方可以通过服务发现组件从注册中心查询目标微服务的地址列表，并通过获取到的服务地址列表，以某种负载策略向目标微服务发起调用。传统的服务注册与发现主要由传统的注册中心提供支持，例如 Nacos、Eureka、Zookeeper 等。

- ### Eureka 注册中心

  Eureka 是 Spring Cloud 官方推荐使用的注册中心。Eureka 主要适用于通过 Java 实现的分布式系统，或是与 JVM 兼容语言构建的系统。但是，由于 Eureka 服务端的服务治理机制提供了完备的 RESTful API，所以也支持将非 Java 语言构建的微服务应用纳入 Eureka 的服务治理体系中来。只是在使用其他语言平台的时候，需要自己来实现 Eureka 的客户端程序。Eureka 集群采⽤⾮ Master/Slave  架构，集群中所有节点⻆⾊⼀致，数据写⼊集群任意⼀个节点后，再由该节点向集群内其他节点进⾏复制实现弱⼀致性同步。

- ### Nacos 注册中心

  Nacos 注册中心是阿里巴巴推出的开源项目，可以轻松构建云原生应用程序和微服务平台。Nacos 致力于发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，主要包括：服务发现和服务健康监测、动态配置服务、动态 DNS 服务、服务及其元数据管理。Nacos 支持几乎所有类型的服务，例如，Dubbo/gRPC 服务、Spring Cloud RESTful 服务或 Kubernetes 服务等。

- ### Zookeeper 注册中心

  Apache ZooKeeper 是开放源码的分布式应用程序协调组件，为分布式应用提供一致性服务的软件。Zookeeper 提供的功能包括：配置维护、域名服务、分布式同步、组服务等。在微服务项目开发中，ZooKeeper 经常和 Dubbo 配合使用，充当服务注册中心。

- ### Spring Cloud 框架

  Spring Cloud 是一款基于 Spring Boot 的微服务框架。Spring Cloud 将市面上成熟的、经过验证的微服务框架整合起来，在 Spring Boot 的基础上进行再封装，屏蔽复杂的配置和实现原理，最终为开发人员提供了一套简单易懂、易部署和易维护的分布式系统开发工具包。Spring Cloud 包括 Spring Cloud Config、Spring Cloud Bus 等 20 多个子项目，提供了服务治理、服务网关、智能路由、负载均衡、熔断器、监控跟踪、分布式消息队列、配置管理等领域的解决方案。

- ### Dubbo 框架

  Apache Dubbo 微服务开发框架提供了 RPC 通信与微服务治理两大关键能力。这意味着，使用 Dubbo 开发的微服务将具备相互之间的远程发现与通信能力。同时，利用 Dubbo 丰富的服务治理能力，可以实现诸如服务发现、负载均衡、流量调度等服务治理诉求。Dubbo 是高度可扩展的，用户几乎可以在任意功能点去定制自己的实现，从而改变框架的默认行为以满足自己的业务需求。Dubbo 目前支持 Consul、Nacos、ZooKeeper、Redis 等多种开源组件作为注册中心。

## 云原生的服务注册与发现

云原生的服务注册与发现使用云原生的注册中心，参见 Kubernetes 注册中心和 Service Mesh 注册中心。

- ### Kubernetes 注册中心

  在 Kubernetes 中能够为微服务提供内部服务注册发现的基础就是 Service 类型的资源。Kubernetes 使用 DNS 作为服务注册表。为了满足这一需要，每个 Kubernetes 集群都会在 kube-system 命名空间中用 Pod 的形式运行一个 DNS 服务 (kube-dns/coredns)，通常称之为集群 DNS。服务注册过程是：1）向 API Server 用 POST 方式提交一个新的 Service 定义。2）该请求需要经过认证、鉴权以及其他的准入策略检查过程之后才会放行。3）Service 得到一个 ClusterIP（虚拟 IP 地址），并保存到集群数据仓库。4）在集群范围内传播 Service 配置。5）集群 DNS 服务得知该 Service 的创建，据此创建必要的 DNS 记录。Service 对象注册到集群 DNS 之中后，就可以通过一个单一稳定的 IP 地址访问该 Service 中的 Pod。

- ### Service Mesh 注册中心

  Service Mesh 作为微服务的注册中心是基于 Kubernetes 实现的。在 Kubernetes 集群环境中安装 Istio 后，Kubernetes 在创建 Pod 时，就会通过 Kube-API server 调用控制面组件的 Sidecar-Injector 服务、自动修改应用程序的描述信息并将其注入 SideCar，之后在创建业务容器的 Pod 中同时创建 SideCar 代理容器。SideCar 则会通过 xDS 协议与 Istio 控制面各组件连接。

## Sentinel

Sentinel 是面向分布式服务架构的流量控制组件，主要以流量为切入点，从流量控制、熔断降级、系统自适应保护等多个维度来保障微服务的稳定性。Sentinel 具有丰富的应用场景，承接了阿里巴巴近 10 年的双十一大促流量的核心场景。Sentinel 具有完备的实时监控，用户可以在控制台中看到接入应用的单台机器的秒级数据。Sentinel 提供与其它开源框架 / 库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合，可以开箱即用。此外，Sentinel 还能提供简单易用、完善的 SPI 扩展接口，用户可以通过实现扩展接口来快速地定制逻辑。

## Envoy

Envoy 是面向服务架构的高性能网络代理，拥有强大的定制化能力。Envoy 是面向服务架构设计的 L7 代理和通信总线，核心是⼀个 L3/L4  网络代理。Envoy 通常以 Sidecar 的方式运行在应用程序的周边，也可以作为网络的边缘代理来运行。Envoy 的特性包括：进程外体系结构、L3/L4 过滤器体系结构、HTTP L7 过滤器体系结构、 一流的 HTTP/2 支持、 HTTP/3 支持、HTTP L7 路由、gRPC 支持、服务发现和动态配置、健康检查、高级负载平衡、前端/边缘代理支持、 一流的可观察性等。
## Contour
Contour 将 Envoy 部署为反向代理和负载均衡器，从而充当 Kubernetes 的入口控制器。Contour 支持动态配置更新，而且还引入了一个新的入口 API (HTTPProxy)。该 API 通过自定义资源定义 (CRD) 实现，目标是扩展 Ingress API 的功能，提供更丰富的用户体验并解决原始设计中的缺陷。Contour 架构灵活，可以部署为 Kubernetes Deployment 或 Daemonset。此外，Contour 还具有 TLS 证书授权特性，管理员可以安全地委派通配符证书访问。

## 限流

限流是流量限速（Rate Limit）的简称，指只允许指定的流量进入系统，超过阈值的流量将被拒绝服务、排队或等待、降级等。限流是为了保障机器和整体业务的稳定性，避免系统雪崩。

## 降级

当服务器压力剧增时，根据实际业务情况及流量，对非核心、非关键的服务有策略地不处理或简化处理，从而释放部分服务器资源以保证核心服务正常运作或高效运作。当整个微服务架构整体的负载超出了预设上限或即将到来的流量预计会超过设定的阈值时，可以做降级处理。

## 熔断

熔断这一概念来源于电子工程中的断路器（Circuit Breaker）。在互联网系统中，当下游服务因访问压力过大而响应变慢或失败，超过设定的阈值时，上游服务会暂时切断对下游服务的调用，从而保护系统整体的可用性。这种牺牲局部，保全整体的措施就叫做熔断。
