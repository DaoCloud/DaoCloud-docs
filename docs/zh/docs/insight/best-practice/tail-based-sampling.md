# é“¾è·¯æ•°æ®é‡‡æ ·ä»‹ç»ä¸é…ç½®

ä½¿ç”¨åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªï¼Œå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è§‚å¯Ÿè¯·æ±‚å¦‚ä½•åœ¨å„ä¸ªç³»ç»Ÿä¸­æµè½¬ã€‚ä¸å¯å¦è®¤ï¼Œå®ƒéå¸¸å®ç”¨ï¼Œä¾‹å¦‚äº†è§£æ‚¨çš„æœåŠ¡è¿æ¥å’Œè¯Šæ–­å»¶è¿Ÿé—®é¢˜ï¼Œä»¥åŠè®¸å¤šå…¶ä»–å¥½å¤„ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„å¤§å¤šæ•°è¯·æ±‚éƒ½æˆåŠŸäº† 200 ç§’ï¼Œå¹¶ä¸”æ²¡æœ‰å‡ºç°ä¸å¯æ¥å—çš„å»¶è¿Ÿæˆ–é”™è¯¯ï¼Œé‚£ä¹ˆæ‚¨çœŸçš„éœ€è¦æ‰€æœ‰è¿™äº›æ•°æ®å—ï¼Ÿæ‰€ä»¥ï¼Œä½ å¹¶ä¸æ€»æ˜¯éœ€è¦å¤§é‡çš„æ•°æ®æ¥æ‰¾åˆ°æ­£ç¡®çš„è§è§£ã€‚æ‚¨åªéœ€è¦é€šè¿‡æ°å½“çš„çš„æ•°æ®é‡‡æ ·å³å¯ã€‚

é‡‡æ ·èƒŒåçš„æƒ³æ³•æ˜¯æ§åˆ¶å‘é€åˆ°å¯è§‚å¯Ÿæ€§æ”¶é›†å™¨çš„é“¾è·¯ï¼Œä»è€Œé™ä½é‡‡é›†æˆæœ¬ã€‚ä¸åŒçš„ç»„ç»‡æœ‰ä¸åŒçš„åŸå› ï¼Œæ¯”å¦‚ä¸ºä»€ä¹ˆè¦æŠ½æ ·ï¼Œä»¥åŠæƒ³è¦æŠ½æ ·ä»€ä¹ˆæ¨çš„æ•°æ®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰é‡‡æ ·ç­–ç•¥ï¼š

- ç®¡ç†æˆæœ¬ï¼šå¦‚æœéœ€è¦å­˜å‚¨å¤§é‡çš„é¥æµ‹æ•°æ®ï¼Œåˆ™éœ€è¦ä»˜å‡ºæ›´å¤šçš„è®¡ç®—ã€å­˜å‚¨æˆæœ¬ã€‚
- å…³æ³¨æœ‰è¶£çš„è·Ÿè¸ªï¼šä¸åŒç»„ç»‡å…³æ³¨çš„æ•°æ®ä¹Ÿä¸åŒã€‚
- è¿‡æ»¤æ‰å™ªéŸ³ï¼šä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½å¸Œæœ›è¿‡æ»¤æ‰å¥åº·æ£€æŸ¥ã€‚

åœ¨è®¨è®ºé‡‡æ ·æ—¶ä½¿ç”¨ä¸€è‡´çš„æœ¯è¯­æ˜¯å¾ˆé‡è¦çš„ã€‚Trace æˆ– Span è¢«è§†ä¸º **é‡‡æ ·** æˆ– **æœªé‡‡æ ·**ï¼š

- é‡‡æ ·ï¼šTrace æˆ– Span è¢«å¤„ç†å¹¶ä¿å­˜ã€‚ä¸ºå®ƒè¢«é‡‡æ ·è€…é€‰æ‹©ä¸ºæ€»ä½“çš„ä»£è¡¨ï¼Œæ‰€ä»¥å®ƒè¢«è®¤ä¸ºæ˜¯ **æŠ½æ ·çš„**ã€‚
- æœªé‡‡æ ·ï¼šä¸è¢«å¤„ç†æˆ–ä¿å­˜çš„ Trace æˆ– Spanã€‚å› ä¸ºå®ƒä¸æ˜¯ç”±é‡‡æ ·å™¨é€‰æ‹©çš„ï¼Œæ‰€ä»¥è¢«è®¤ä¸ºæ˜¯ **æœªé‡‡æ ·**ã€‚

## é‡‡æ ·çš„æ–¹å¼æœ‰å“ªäº›ï¼Ÿ

### å¤´éƒ¨é‡‡æ ·ï¼ˆHead Samplingï¼‰

å¤´éƒ¨æŠ½æ ·æ˜¯ä¸€ç§æŠ½æ ·æŠ€æœ¯ï¼Œç”¨äºå°½æ—©åšå‡ºæŠ½æ ·å†³å®šã€‚é‡‡æ ·æˆ–åˆ é™¤ Trace æˆ– Span çš„å†³å®šä¸æ˜¯é€šè¿‡æ£€æŸ¥æ•´ä¸ª Trace æ¥åšå‡ºçš„ã€‚

ä¾‹å¦‚ï¼Œæœ€å¸¸è§çš„å¤´éƒ¨æŠ½æ ·å½¢å¼æ˜¯ä¸€è‡´æ¦‚ç‡æŠ½æ ·ã€‚å®ƒä¹Ÿå¯ä»¥ç§°ä¸ºç¡®å®šæ€§é‡‡æ ·ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†æ ¹æ® TraceID å’Œè¦é‡‡æ ·çš„æ‰€éœ€ Trace ç™¾åˆ†æ¯”åšå‡ºé‡‡æ ·å†³ç­–ã€‚è¿™å¯ç¡®ä¿ä»¥ä¸€è‡´çš„é€Ÿç‡ï¼ˆä¾‹å¦‚æ‰€æœ‰ Traceçš„ 5%ï¼‰å¯¹æ•´ä¸ª Trace è¿›è¡Œé‡‡æ ·ï¼ˆä¸é—æ¼ Spanã€‚

å¤´éƒ¨é‡‡æ ·çš„å¥½å¤„æ˜¯ï¼š
- æ˜“äºç†è§£
- æ˜“äºé…ç½®
- é«˜æ•ˆ
- å¯ä»¥åœ¨è·Ÿè¸ªæ”¶é›†ç®¡é“ä¸­çš„ä»»ä½•ä½ç½®å®Œæˆ

å¤´éƒ¨é‡‡æ ·çš„ä¸»è¦ç¼ºç‚¹æ˜¯æ— æ³•æ ¹æ®æ•´ä¸ª Trace ä¸­çš„æ•°æ®åšå‡ºé‡‡æ ·å†³ç­–ã€‚è¿™æ„å‘³ç€å¤´éƒ¨æŠ½æ ·ä½œä¸ºä¸€ç§é’å™¨æ˜¯æœ‰æ•ˆçš„ï¼Œä½†å¯¹äºå¿…é¡»è€ƒè™‘æ•´ä¸ªç³»ç»Ÿä¿¡æ¯çš„æŠ½æ ·ç­–ç•¥æ¥è¯´ï¼Œè¿™æ˜¯å®Œå…¨ä¸å¤Ÿçš„ã€‚ä¾‹å¦‚ï¼Œæ— æ³•ä½¿ç”¨å¤´éƒ¨é‡‡æ ·æ¥ç¡®ä¿å¯¹æ‰€æœ‰å…·æœ‰è¯¯å·®çš„è¿¹çº¿è¿›è¡Œé‡‡æ ·ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦å°¾éƒ¨é‡‡æ ·ã€‚

### å°¾éƒ¨é‡‡æ ·ï¼ˆTail Samplingï¼‰â€”â€” æ¨èæ–¹æ¡ˆ

å°¾éƒ¨é‡‡æ ·æ˜¯é€šè¿‡è€ƒè™‘ Trace å†…çš„å…¨éƒ¨æˆ–å¤§éƒ¨åˆ† Span æ¥å†³å®šå¯¹ Trace è¿›è¡Œé‡‡æ ·ã€‚å°¾éƒ¨é‡‡æ ·å…è®¸æ‚¨æ ¹æ®ä» Trace çš„ä¸åŒéƒ¨åˆ†ä½¿ç”¨çš„ç‰¹å®šæ¡ä»¶å¯¹ Trace è¿›è¡Œé‡‡æ ·ï¼Œè€Œå¤´éƒ¨é‡‡æ ·åˆ™ä¸å…·æœ‰æ­¤é€‰é¡¹ã€‚

å¦‚ä½•ä½¿ç”¨å°¾éƒ¨é‡‡æ ·çš„ä¸€äº›ç¤ºä¾‹åŒ…æ‹¬ï¼š

- å§‹ç»ˆå¯¹åŒ…å«é”™è¯¯çš„ Trace è¿›è¡Œé‡‡æ ·
- åŸºäºæ€»ä½“å»¶è¿Ÿçš„é‡‡æ ·
- æ ¹æ® Trace ä¸­ä¸€ä¸ªæˆ–å¤šä¸ª Span ä¸Šç‰¹å®šå±æ€§çš„å­˜åœ¨æˆ–å€¼å¯¹ Trace è¿›è¡Œé‡‡æ ·; ä¾‹å¦‚ï¼Œå¯¹æºè‡ªæ–°éƒ¨ç½²çš„æœåŠ¡çš„æ›´å¤š Trace è¿›è¡Œé‡‡æ ·
- æ ¹æ®ç‰¹å®šæ¡ä»¶å¯¹ Trace åº”ç”¨ä¸åŒçš„é‡‡æ ·ç‡

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œå°¾éƒ¨é‡‡æ ·æœ‰ç€æ›´é«˜ç¨‹åº¦çš„å¤æ‚åº¦ã€‚å¯¹äºå¿…é¡»å¯¹é¥æµ‹æ•°æ®è¿›è¡Œé‡‡æ ·çš„å¤§å‹ç³»ç»Ÿï¼Œå‡ ä¹æ€»æ˜¯éœ€è¦ä½¿ç”¨å°¾éƒ¨é‡‡æ ·æ¥å¹³è¡¡æ•°æ®é‡å’Œæ•°æ®çš„æœ‰ç”¨æ€§ã€‚

å¦‚ä»Šï¼Œå°¾éƒ¨é‡‡æ ·æœ‰ä¸‰ä¸ªä¸»è¦ç¼ºç‚¹ï¼š

- å°¾éƒ¨é‡‡æ ·å¯èƒ½éš¾ä»¥æ“ä½œã€‚å®ç°å°¾éƒ¨é‡‡æ ·çš„ç»„ä»¶å¿…é¡»æ˜¯å¯ä»¥æ¥å—å’Œå­˜å‚¨å¤§é‡æ•°æ®çš„æœ‰çŠ¶æ€ç³»ç»Ÿã€‚æ ¹æ®æµé‡æ¨¡å¼ï¼Œè¿™å¯èƒ½éœ€è¦æ•°åä¸ªç”šè‡³æ•°ç™¾ä¸ªèŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹éƒ½ä»¥ä¸åŒçš„æ–¹å¼åˆ©ç”¨èµ„æºã€‚æ­¤å¤–ï¼Œå¦‚æœå°¾éƒ¨é‡‡æ ·å™¨æ— æ³•è·Ÿä¸Šæ¥æ”¶çš„æ•°æ®é‡ï¼Œåˆ™å¯èƒ½éœ€è¦â€œå›é€€â€åˆ°è®¡ç®—å¯†é›†åº¦è¾ƒä½çš„é‡‡æ ·æŠ€æœ¯ã€‚ç”±äºè¿™äº›å› ç´ ï¼Œç›‘æ§å°¾éƒ¨é‡‡æ ·ç»„ä»¶ä»¥ç¡®ä¿å®ƒä»¬æ‹¥æœ‰åšå‡ºæ­£ç¡®é‡‡æ ·å†³ç­–æ‰€éœ€çš„èµ„æºè‡³å…³é‡è¦ã€‚
- å°¾éƒ¨é‡‡æ ·å¯èƒ½éš¾ä»¥å®ç°ã€‚æ ¹æ®æ‚¨å¯ç”¨çš„é‡‡æ ·æŠ€æœ¯ç±»å‹ï¼Œå®ƒå¹¶ä¸æ€»æ˜¯â€œä¸€åŠ³æ°¸é€¸â€çš„äº‹æƒ…ã€‚éšç€ç³»ç»Ÿçš„å˜åŒ–ï¼Œæ‚¨çš„é‡‡æ ·ç­–ç•¥ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚å¯¹äºå¤§å‹è€Œå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå®ç°é‡‡æ ·ç­–ç•¥çš„è§„åˆ™ä¹Ÿå¯ä»¥æ˜¯åºå¤§è€Œå¤æ‚çš„ã€‚
- å¦‚ä»Šï¼Œå°¾éƒ¨é‡‡æ ·å™¨é€šå¸¸æœ€ç»ˆå±äºä¾›åº”å•†ç‰¹å®šæŠ€æœ¯é¢†åŸŸã€‚å¦‚æœæ‚¨ä½¿ç”¨ä»˜è´¹ä¾›åº”å•†æ¥å®ç°å¯è§‚æµ‹æ€§ï¼Œåˆ™å¯ç”¨çš„æœ€æœ‰æ•ˆçš„å°¾éƒ¨é‡‡æ ·é€‰é¡¹å¯èƒ½ä»…é™äºä¾›åº”å•†æä¾›çš„å†…å®¹ã€‚

æœ€åï¼Œå¯¹äºæŸäº›ç³»ç»Ÿï¼Œå°¾éƒ¨é‡‡æ ·å¯ä»¥ä¸å¤´éƒ¨é‡‡æ ·ç»“åˆä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ç»„ç”Ÿæˆå¤§é‡ Trace æ•°æ®çš„æœåŠ¡å¯èƒ½é¦–å…ˆä½¿ç”¨å¤´éƒ¨é‡‡æ ·ä»…å¯¹ä¸€å°éƒ¨åˆ†è·Ÿè¸ªè¿›è¡Œé‡‡æ ·ï¼Œç„¶ååœ¨é¥æµ‹ç®¡é“ä¸­ç¨åä½¿ç”¨å°¾éƒ¨é‡‡æ ·åœ¨å¯¼å‡ºåˆ°åç«¯ä¹‹å‰åšå‡ºæ›´å¤æ‚çš„é‡‡æ ·å†³ç­–ã€‚è¿™æ ·åšé€šå¸¸æ˜¯ä¸ºäº†ä¿æŠ¤é¥æµ‹ç®¡é“å…äºè¿‡è½½ã€‚

**DCE5 Insight ç›®å‰æ¨èä½¿ç”¨å°¾éƒ¨é‡‡æ ·å¹¶ä¼˜å…ˆæ”¯æŒå°¾éƒ¨é‡‡æ ·ã€‚**

å°¾éƒ¨é‡‡æ ·å¤„ç†å™¨æ ¹æ®ä¸€ç»„å®šä¹‰çš„ç­–ç•¥å¯¹é“¾è·¯è¿›è¡Œé‡‡æ ·ã€‚ä½†æ˜¯ï¼Œé“¾è·¯çš„æ‰€æœ‰è·¨åº¦ï¼ˆspanï¼‰å¿…é¡»ç”±åŒä¸€æ”¶é›†å™¨å®ä¾‹æ¥æ”¶ï¼Œä»¥åšå‡ºæœ‰æ•ˆçš„é‡‡æ ·å†³ç­–ã€‚

å› æ­¤ï¼Œéœ€è¦å¯¹ Insight çš„ Global Opentelemetry Collector æ¶æ„è¿›è¡Œè°ƒæ•´ä»¥å®ç°å°¾éƒ¨é‡‡æ ·ç­–ç•¥ã€‚

## Insight å…·ä½“æ”¹åŠ¨

åœ¨ Global é›†ç¾¤ä¸­çš„ `insight-opentelemetry-collector` å‰é¢å¼•å…¥å…·æœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ Opentelemetry Collector Gateway ç»„ä»¶ï¼Œä½¿å¾—åŒä¸€ç»„ Trace èƒ½å¤Ÿæ ¹æ® TraceID è·¯ç”±åˆ°åŒä¸€ä¸ª Opentelemetry Collector å®ä¾‹ã€‚

1. éƒ¨ç½²å…·æœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„ OTEL COL Gateway ç»„ä»¶

å¦‚æœæ‚¨ä½¿ç”¨äº† Insight 0.25.x ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ Helm Upgrade å‚æ•° `--set opentelemetry-collector-gateway.enabled=true` å¿«é€Ÿå¼€å¯ï¼Œä»¥æ­¤è·³è¿‡å¦‚ä¸‹éƒ¨ç½²è¿‡ç¨‹ã€‚

å‚ç…§ä»¥ä¸‹ YAML é…ç½®æ¥éƒ¨ç½²ã€‚

??? note "ç‚¹å‡»æŸ¥çœ‹éƒ¨ç½²é…ç½®"

    ```yaml
    kind: ClusterRole
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
      name: insight-otel-collector-gateway
    rules:
    - apiGroups: [""]
      resources: ["endpoints"]
      verbs: ["get", "watch", "list"]
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: insight-otel-collector-gateway
      namespace: insight-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: insight-otel-collector-gateway
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: insight-otel-collector-gateway
    subjects:
    - kind: ServiceAccount
      name: insight-otel-collector-gateway
      namespace: insight-system
    ---
    kind: ConfigMap
    metadata:
      labels:
        app.kubernetes.io/component: opentelemetry-collector
        app.kubernetes.io/instance: insight-otel-collector-gateway
        app.kubernetes.io/name: insight-otel-collector-gateway
      name: insight-otel-collector-gateway-collector
      namespace: insight-system
    apiVersion: v1
    data:
      collector.yaml: |
        receivers:
          otlp:
            protocols:
              grpc:
              http:
          jaeger:
            protocols:
              grpc:
        processors:
    
        extensions:
          health_check:
          pprof:
            endpoint: :1888
          zpages:
            endpoint: :55679
        exporters:
          logging:
          loadbalancing:
            routing_key: "traceID"
            protocol:
              otlp:
                # all options from the OTLP exporter are supported
                # except the endpoint
                timeout: 1s
                tls:
                  insecure: true
            resolver:
              k8s:
                service: insight-opentelemetry-collector
                ports:
                  - 4317
        service:
          extensions: [pprof, zpages, health_check]
          pipelines:
            traces:
              receivers: [otlp, jaeger]
              exporters: [loadbalancing]
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app.kubernetes.io/component: opentelemetry-collector
        app.kubernetes.io/instance: insight-otel-collector-gateway
        app.kubernetes.io/name: insight-otel-collector-gateway
      name: insight-otel-collector-gateway
      namespace: insight-system
    spec:
      replicas: 2
      selector:
        matchLabels:
          app.kubernetes.io/component: opentelemetry-collector
          app.kubernetes.io/instance: insight-otel-collector-gateway
          app.kubernetes.io/name: insight-otel-collector-gateway
      template:
        metadata:
          labels:
            app.kubernetes.io/component: opentelemetry-collector
            app.kubernetes.io/instance: insight-otel-collector-gateway
            app.kubernetes.io/name: insight-otel-collector-gateway
        spec:
          containers:
          - args:
            - --config=/conf/collector.yaml
            env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            image: ghcr.m.daocloud.io/openinsight-proj/opentelemetry-collector-contrib:5baef686672cfe5551e03b5c19d3072c432b6f33
            imagePullPolicy: IfNotPresent
            livenessProbe:
              failureThreshold: 3
              httpGet:
                path: /
                port: 13133
                scheme: HTTP
              periodSeconds: 10
              successThreshold: 1
              timeoutSeconds: 1
            name: otc-container
            resources:
              limits:
                cpu: '1'
                memory: 2Gi
              requests:
                cpu: 100m
                memory: 400Mi
            ports:
            - containerPort: 14250
              name: jaeger-grpc
              protocol: TCP
            - containerPort: 8888
              name: metrics
              protocol: TCP
            - containerPort: 4317
              name: otlp-grpc
              protocol: TCP
            - containerPort: 4318
              name: otlp-http
              protocol: TCP
            - containerPort: 55679
              name: zpages
              protocol: TCP
    
            volumeMounts:
            - mountPath: /conf
              name: otc-internal
    
          serviceAccount: insight-otel-collector-gateway
          serviceAccountName: insight-otel-collector-gateway
          volumes:
          - configMap:
              defaultMode: 420
              items:
              - key: collector.yaml
                path: collector.yaml
              name: insight-otel-collector-gateway-collector
            name: otc-internal
    ---
    kind: Service
    apiVersion: v1
    metadata:
      name: insight-opentelemetry-collector-gateway
      namespace: insight-system
      labels:
        app.kubernetes.io/component: opentelemetry-collector
        app.kubernetes.io/instance: insight-otel-collector-gateway
        app.kubernetes.io/name: insight-otel-collector-gateway
    spec:
      ports:
        - name: fluentforward
          protocol: TCP
          port: 8006
          targetPort: 8006
        - name: jaeger-compact
          protocol: UDP
          port: 6831
          targetPort: 6831
        - name: jaeger-grpc
          protocol: TCP
          port: 14250
          targetPort: 14250
        - name: jaeger-thrift
          protocol: TCP
          port: 14268
          targetPort: 14268
        - name: metrics
          protocol: TCP
          port: 8888
          targetPort: 8888
        - name: otlp
          protocol: TCP
          appProtocol: grpc
          port: 4317
          targetPort: 4317
        - name: otlp-http
          protocol: TCP
          port: 4318
          targetPort: 4318
        - name: zipkin
          protocol: TCP
          port: 9411
          targetPort: 9411
        - name: zpages
          protocol: TCP
          port: 55679
          targetPort: 55679
      selector:
        app.kubernetes.io/component: opentelemetry-collector
        app.kubernetes.io/instance: insight-otel-collector-gateway
        app.kubernetes.io/name: insight-otel-collector-gateway
    ```

2. é…ç½®å°¾éƒ¨é‡‡æ ·è§„åˆ™

!!! note

    éœ€è¦åœ¨åŸæœ¬ insight-otel-collector-config configmap é…ç½®ç»„ä¸­å¢åŠ å°¾éƒ¨é‡‡æ ·ï¼ˆtail_sampling processorsï¼‰çš„è§„åˆ™ã€‚

1. åœ¨ `processor` ä¸­å¢åŠ å¦‚ä¸‹å†…å®¹ï¼Œå…·ä½“è§„åˆ™å¯è°ƒæ•´ï¼›å‚è€ƒ [OTel å®˜æ–¹ç¤ºä¾‹](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/tailsamplingprocessor/README.md#a-practical-example)ã€‚

    ```yaml
    ........
    tail_sampling:
      decision_wait: 10s # ç­‰å¾… 10 ç§’ï¼Œè¶…è¿‡ 10 ç§’åçš„ traceid å°†ä¸å†å¤„ç†
      num_traces: 1500000  # å†…å­˜ä¸­ä¿å­˜çš„ trace æ•°ï¼Œå‡è®¾æ¯ç§’ 1000 æ¡ traceï¼Œæœ€å°ä¸ä½äº 1000 * decision_wait * 2ï¼›
                           # è®¾ç½®è¿‡å¤§ä¼šå ç”¨è¿‡å¤šçš„å†…å­˜èµ„æºï¼Œè¿‡å°ä¼šå¯¼è‡´éƒ¨åˆ† trace è¢« drop æ‰
      expected_new_traces_per_sec: 10
      policies: # ä¸ŠæŠ¥ç­–ç•¥
        [
            {
              name: latency-policy,
              type: latency,  # è€—æ—¶è¶…è¿‡ 500ms ä¸ŠæŠ¥
              latency: {threshold_ms: 500}
            },
            {
              name: status_code-policy,
              type: status_code,  # çŠ¶æ€ç ä¸º ERROR çš„ä¸ŠæŠ¥
              status_code: {status_codes: [ ERROR ]}
            }
        ]
    ......
    tail_sampling: # ç»„åˆé‡‡æ ·
      decision_wait: 10s # ç­‰å¾… 10 ç§’ï¼Œè¶…è¿‡ 10 ç§’åçš„ traceid å°†ä¸å†å¤„ç†
      num_traces: 1500000  # å†…å­˜ä¸­ä¿å­˜çš„ trace æ•°ï¼Œå‡è®¾æ¯ç§’ 1000 æ¡ traceï¼Œæœ€å°ä¸ä½äº 1000 * decision_wait * 2ï¼›
                           # è®¾ç½®è¿‡å¤§ä¼šå ç”¨è¿‡å¤šçš„å†…å­˜èµ„æºï¼Œè¿‡å°ä¼šå¯¼è‡´éƒ¨åˆ† trace è¢« drop æ‰
      expected_new_traces_per_sec: 10
      policies: [
          {
            name: debug-worker-cluster-sample-policy,
            type: and,
            and:
              {
                and_sub_policy:
                  [
                    {
                      name: service-name-policy,
                      type: string_attribute,
                      string_attribute:
                        { key: k8s.cluster.id, values: [xxxxxxx] },
                    },
                    {
                      name: trace-status-policy,
                      type: status_code,
                      status_code: { status_codes: [ERROR] },
                    },
                    {
                      name: probabilistic-policy,
                      type: probabilistic,
                      probabilistic: { sampling_percentage: 1 },
                    }
                  ]
              }
          }
        ]
    ```

2. åœ¨ `insight-otel-collector-config` **configmap** ä¸­çš„ otel col pipeline ä¸­æ¿€æ´»è¯¥ `processor`ï¼š

    ```yaml
    traces:
      exporters:
        - servicegraph
        - otlp/jaeger
      processors:
        - memory_limiter
        - tail_sampling # ğŸ‘ˆ
        - batch
      receivers:
        - otlp
    ```

3. é‡å¯ `insight-opentelemetry-collector` ç»„ä»¶ã€‚

4. éƒ¨ç½²æˆ–æ›´æ–° Insight-agentï¼Œå°†é“¾è·¯æ•°æ®çš„ä¸ŠæŠ¥åœ°å€ä¿®æ”¹ä¸º `opentelemetry-collector-gateway` LB çš„ `4317` ç«¯å£åœ°å€ã€‚

    ```yaml
    ....
        exporters:
          otlp/global:
            endpoint: insight-opentelemetry-collector-gateway.insight-system.svc.cluster.local:4317  # ğŸ‘ˆ ä¿®æ”¹ä¸º gateway/lb åœ°å€
    ```
