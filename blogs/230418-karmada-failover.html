
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="DaoCloud Enterprise 5.0 下一代容器化平台集大成者，引领云原生浪潮，推动数字化转型。" name="description"/>
<meta content="DaoCloud" name="author"/>
<link href="https://docs.daocloud.io/blogs/230418-karmada-failover.html" rel="canonical"/>
<link href="230427-victoriametrics.html" rel="prev"/>
<link href="230417-cncf-platform-wp.html" rel="next"/>
<link href="../images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.5.49" name="generator"/>
<title>Karmada Failover 详解 - DaoCloud Enterprise</title>
<link href="../assets/stylesheets/main.6f8fc17f.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link href="../overrides/assets/stylesheets/main.e13ced4c.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../stylesheets/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-WDCH551J9C"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-WDCH551J9C",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-WDCH551J9C",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#karmada-failover">
          跳转至
        </a>
</div>
<div data-md-component="announce">
<aside class="md-banner">
<div class="md-banner__inner md-grid md-typeset">
<a href="/dce/license0/">
   DaoCloud 第五代产品全新上线咯！<strong>点击链接，免费体验！</strong>

</a>
</div>
</aside>
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="DaoCloud Enterprise" class="md-header__button md-logo" data-md-component="logo" href="/" title="DaoCloud Enterprise">
<img alt="logo" src="../images/DaoCloud.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            DaoCloud Enterprise
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Karmada Failover 详解
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<div class="md-header__option">
<div class="md-select">
<button aria-label="选择当前语言" class="md-header__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg>
</button>
<div class="md-select__inner">
<ul class="md-select__list">
<li class="md-select__item">
<a class="md-select__link" href="/" hreflang="zh">
              简体中文
            </a>
</li>
<li class="md-select__item">
<a class="md-select__link" href="/en/" hreflang="en">
              English
            </a>
</li>
</ul>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<a aria-label="分享" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="分享">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
</a>
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/DaoCloud/DaoCloud-docs" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</div>
<div class="md-source__repository">
    DaoCloud/DaoCloud-docs
  </div>
</a>
</div>
</nav>
<nav aria-label="标签" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="https://www.daocloud.io/">
        
  
    
  
  DaoCloud 官网

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../dce/index.html">
          
  
  产品文档

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../videos/index.html">
          
  
  视频教程

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../download/index.html">
          
  
  下载中心

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="index.html">
          
  
  博客

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../community/index.html">
          
  
  DaoCloud 开源生态

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../native/news/news-2024.html">
          
  
  云原生研究院

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../trial/index.html">
          
  
  免费体验

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="DaoCloud Enterprise" class="md-nav__button md-logo" data-md-component="logo" href="/" title="DaoCloud Enterprise">
<img alt="logo" src="../images/DaoCloud.png"/>
</a>
    DaoCloud Enterprise
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/DaoCloud/DaoCloud-docs" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</div>
<div class="md-source__repository">
    DaoCloud/DaoCloud-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="https://www.daocloud.io/">
<span class="md-ellipsis">
    DaoCloud 官网
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../dce/index.html">
<span class="md-ellipsis">
    产品文档
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../videos/index.html">
<span class="md-ellipsis">
    视频教程
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../download/index.html">
<span class="md-ellipsis">
    下载中心
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
<span class="md-ellipsis">
    博客
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            博客
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="index.html">
<span class="md-ellipsis">
    博文索引
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="">
<span class="md-ellipsis">
    2024
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_2">
<span class="md-nav__icon md-icon"></span>
            2024
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="241108-cncf-ambassador.html">
<span class="md-ellipsis">
    从社区小白到 CNCF 大使
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="241106-containerd-nerdctl-lima.html">
<span class="md-ellipsis">
    containerd 相关项目集中发布新版本
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240816-1.31-image.html">
<span class="md-ellipsis">
    K8s 1.31 OCI 工件的只读卷
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="20240619-nvidiaai.html">
<span class="md-ellipsis">
    Nvidia 征服最新的 AI 测试
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="0606-k8s-birth.html">
<span class="md-ellipsis">
    Kubernetes 十周年
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240516-sig-docs.html">
<span class="md-ellipsis">
    K8s 从敲代码到抒发文笔
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240509-model-spec.html">
<span class="md-ellipsis">
    OpenAI 大语言模型规范
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="0429-ai-survey.html">
<span class="md-ellipsis">
    全球大规模AI基础设施形势调研
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240416-kubean.html">
<span class="md-ellipsis">
    一颗豆荚入选CNCF Sandbox
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240410-cnai-wp.html">
<span class="md-ellipsis">
    云原生人工智能白皮书
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240326-kubecon-eu.html">
<span class="md-ellipsis">
    巴黎 KubeCon 谁在引领创新
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240301-osc-eco.html">
<span class="md-ellipsis">
    创建一个开源商业生态体系
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240203-book.html">
<span class="md-ellipsis">
    好书《K8s云原生数据管理》
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240201-ai-compute.html">
<span class="md-ellipsis">
    加速计算基本定义及工作原理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240115-news.html">
<span class="md-ellipsis">
    容器化 AI 简化 ML 模型的部署
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="240108-kubeedge.html">
<span class="md-ellipsis">
    KubeEdge v1.15.0 发布
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_5_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="">
<span class="md-ellipsis">
    2023
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_5_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_3">
<span class="md-nav__icon md-icon"></span>
            2023
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="231220-spiderpool.html">
<span class="md-ellipsis">
    Spiderpool入选CNCF Sandbox
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="231213-k8s-1.29.html">
<span class="md-ellipsis">
    K8s 1.29发布宇宙主题雄心勃勃
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="231205-vm-bm-compare.html">
<span class="md-ellipsis">
    K8s 裸机 vs 虚机性能对比
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="231115-k8s-1.29-changes.html">
<span class="md-ellipsis">
    K8s 1.29前瞻：移除、弃用及变更
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="231008-kcs.html">
<span class="md-ellipsis">
    上海 K8s 贡献者峰会回顾
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230911-kubecon-contributor.html">
<span class="md-ellipsis">
    上海 K8s 贡献者峰会召集令
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230824-tools.html">
<span class="md-ellipsis">
    K8s 本地开发工具比较
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230815-k8s1.28.html">
<span class="md-ellipsis">
    K8s 1.28 震撼发布
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230808-k8sgpt.html">
<span class="md-ellipsis">
    K8sGPT 赋能 K8s
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230615-ray.html">
<span class="md-ellipsis">
    AIGC 利器 Ray 探索下篇
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230612-ray.html">
<span class="md-ellipsis">
    AIGC 利器 Ray 探索上篇
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230609-istio118.html">
<span class="md-ellipsis">
    Istio 1.18 正式发布
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230605-fedstate.html">
<span class="md-ellipsis">
    联邦中间件FedState
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230601-api-server-tracing.html">
<span class="md-ellipsis">
    API Server Tracing进阶
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230518-seccom.html">
<span class="md-ellipsis">
    边缘场景玩转seccomp
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230515-chaos-mesh.html">
<span class="md-ellipsis">
    混沌工程 Chaos Mesh
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230509-k8s-install.html">
<span class="md-ellipsis">
    K8s 安装教程(KLTS版)
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230508-cilium.html">
<span class="md-ellipsis">
    Cilium 实现 socket 加速
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230428-pod-startup.html">
<span class="md-ellipsis">
    K8s 1.27 加快 Pod 启动
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230427-victoriametrics.html">
<span class="md-ellipsis">
    云原生监控之基础篇
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Karmada Failover 详解
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="230418-karmada-failover.html">
<span class="md-ellipsis">
    Karmada Failover 详解
  </span>
</a>
<nav aria-label="导航" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      导航
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
<span class="md-ellipsis">
      为什么需要故障转移
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#karmada">
<span class="md-ellipsis">
      Karmada 故障恢复示例
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#karmada_1">
<span class="md-ellipsis">
      Karmada 故障恢复实现原理
    </span>
</a>
<nav aria-label="Karmada 故障恢复实现原理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#clusterstatus-controller">
<span class="md-ellipsis">
      clusterStatus controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cluster-controller">
<span class="md-ellipsis">
      cluster controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#taint-manager-controller">
<span class="md-ellipsis">
      taint-manager controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#karmada-scheduler">
<span class="md-ellipsis">
      Karmada scheduler
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gracefuleviction-controller">
<span class="md-ellipsis">
      gracefulEviction controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#binding-controller">
<span class="md-ellipsis">
      binding controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#execution-controller">
<span class="md-ellipsis">
      execution controller
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      总结
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      参考资料
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230417-cncf-platform-wp.html">
<span class="md-ellipsis">
    CNCF 平台工程白皮书
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230412-k8s-1.27.html">
<span class="md-ellipsis">
    K8s 1.27 正式发布
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230411-spiderpool.html">
<span class="md-ellipsis">
    固定应用 IP 的新选择
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230405-step-by-step-dce5.html">
<span class="md-ellipsis">
    保姆式安装社区版
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230317-edge-app-wp.html">
<span class="md-ellipsis">
    边缘原生应用准则
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230315-install-on-linux.html">
<span class="md-ellipsis">
    Linux 单机安装社区版
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230315-install-on-macos.html">
<span class="md-ellipsis">
    macOS 单机安装社区版
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230301-kwok.html">
<span class="md-ellipsis">
    KWOK 介绍
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230214-open-projects.html">
<span class="md-ellipsis">
    社区版涉及的开源项目
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230214-daocloud_k8s.html">
<span class="md-ellipsis">
    DaoCloud 与 K8s
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230201-peter.html">
<span class="md-ellipsis">
    DCE 5.0 攻坚语录集
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230201-forecast.html">
<span class="md-ellipsis">
    2023 年云原生预测
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="230110-res-usage.html">
<span class="md-ellipsis">
    让闲置算力跑起来
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="">
<span class="md-ellipsis">
    2022
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_4">
<span class="md-nav__icon md-icon"></span>
            2022
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="221209-k8s-1.26.html">
<span class="md-ellipsis">
    K8s 1.26 正式发布
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="221116-kcsp.html">
<span class="md-ellipsis">
    K8s 资深认证服务商
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="221026-kpanda.html">
<span class="md-ellipsis">
    容器管理能力介绍
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="221018-resource.html">
<span class="md-ellipsis">
    资源管理能力介绍
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="220925-amamba.html">
<span class="md-ellipsis">
    应用工作台能力介绍
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="220808-kairship.html">
<span class="md-ellipsis">
    多云编排能力介绍
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="220708-mspider.html">
<span class="md-ellipsis">
    服务网格能力介绍
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="221008-dce-bg.html">
<span class="md-ellipsis">
    DCE 开发背景
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../community/index.html">
<span class="md-ellipsis">
    DaoCloud 开源生态
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../native/news/news-2024.html">
<span class="md-ellipsis">
    云原生研究院
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../trial/index.html">
<span class="md-ellipsis">
    免费体验
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      导航
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
<span class="md-ellipsis">
      为什么需要故障转移
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#karmada">
<span class="md-ellipsis">
      Karmada 故障恢复示例
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#karmada_1">
<span class="md-ellipsis">
      Karmada 故障恢复实现原理
    </span>
</a>
<nav aria-label="Karmada 故障恢复实现原理" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#clusterstatus-controller">
<span class="md-ellipsis">
      clusterStatus controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cluster-controller">
<span class="md-ellipsis">
      cluster controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#taint-manager-controller">
<span class="md-ellipsis">
      taint-manager controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#karmada-scheduler">
<span class="md-ellipsis">
      Karmada scheduler
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#gracefuleviction-controller">
<span class="md-ellipsis">
      gracefulEviction controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#binding-controller">
<span class="md-ellipsis">
      binding controller
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#execution-controller">
<span class="md-ellipsis">
      execution controller
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_2">
<span class="md-ellipsis">
      总结
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#_3">
<span class="md-ellipsis">
      参考资料
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/DaoCloud/DaoCloud-docs/commits/main/docs/zh/docs/blogs/230418-karmada-failover.md" title="查看编辑历史">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 8H12v5l4.28 2.54.72-1.21-3.5-2.08zM13 3a9 9 0 0 0-9 9H1l3.96 4.03L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.9 8.9 0 0 0 13 21a9 9 0 0 0 9-9 9 9 0 0 0-9-9"></path></svg>
</a>
<a class="md-content__button md-icon" href="https://github.com/DaoCloud/DaoCloud-docs/edit/main/docs/zh/docs/blogs/230418-karmada-failover.md" title="edit.link.title">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
</a>
<a class="md-content__button md-icon" href="https://raw.githubusercontent.com/DaoCloud/DaoCloud-docs/main/docs/zh/docs/blogs/230418-karmada-failover.md" title="查看源文件">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"></path></svg>
</a>
<h1 id="karmada-failover">Karmada Failover 详解<a class="headerlink" href="#karmada-failover" title="Permanent link">¶</a></h1>
<p>作者：<a href="https://github.com/Fish-pro">Fish-pro</a></p>
<p><img alt="karmada failover" src="https://docs.daocloud.io/daocloud-docs-images/docs/zh/docs/blogs/images/karmada01.png"/></p>
<p>多云时代，如何实现应用跨数据中心，跨可用区和跨集群高可用，成为我们探讨的新话题。
在单个集群中，如果集群发生故障，那么在集群中的所有应用将不可被访问。
是否有方式帮助我们在集群发生故障时，应用自动迁移到新的集群，保证应用持续的对外访问呢？
显然，<strong>Karmada 作为目前社区最火热的多云项目，提供了这样的能力。</strong></p>
<p>Karmada (Kubernetes Armada) 使用户能够跨多个集群运行云原生应用，而不需更改已有的应用。
通过使用 Kubernetes 原生 API 提供高级调度功能，实现了真正开放的多云。Karmada
旨在为多云和混合云场景下的多集群应用管理提供便捷的自动化，具有集中式多云管理、高可用性和故障恢复等关键特性。
<strong>本文基于 Karmada 的 release 版本 v1.4.2，将和大家一起来探究一下 Karmada 跨集群的故障恢复是如何实现的</strong> ，
有哪些控制器和调度器参与到这个过程中，以及每个控制器在这个过程中承担了什么样的能力，调度器承担了什么样的能力，
以及如何保证用户业务的高可用性和连续性？</p>
<p>如果您在阅读本文之前，还未了解或使用过 Karmada，推荐阅读：</p>
<ol>
<li><a href="https://karmada.io/docs/">Karmada 官方文档</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA5NTUxNzE4MQ==&amp;mid=2659273869&amp;idx=1&amp;sn=f6e03df6f34aa6106972193dba1604d8&amp;chksm=8bcbcc1fbcbc4509060f92b3d636c28c6ccaad62fa3aeb4da9f17971b06e655d1d1385ab2f2c&amp;scene=21#wechat_redirect">云原生多云应用利器 -- Karmada 总览篇</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA5NTUxNzE4MQ==&amp;mid=2659273922&amp;idx=1&amp;sn=f17630589507999fc0690741c22178b9&amp;scene=21#wechat_redirect">云原生多云应用利器 -- Karmada 控制器</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA5NTUxNzE4MQ==&amp;mid=2659273971&amp;idx=1&amp;sn=2c81b1959c101573b5b185c342495f30&amp;chksm=8bcbcc61bcbc45772270811a23c210e3faa156078e991f56a288bd58be4246e9572badfb1fbc&amp;scene=21&amp;cur_album_id=2687691821095059459#wechat_redirect">云原生多云应用利器 -- Karmada 调度器</a></li>
</ol>
<h2 id="_1">为什么需要故障转移<a class="headerlink" href="#_1" title="Permanent link">¶</a></h2>
<p>首先，我们来梳理一下，实现故障转移的必要性：</p>
<ul>
<li>管理员在 Karmada 控制平面上部署离线应用，并将 Pod 实例分配到多个集群。
  当集群发生故障时，管理员希望 Karmada 将故障集群中的 Pod 实例迁移到满足条件的其他集群中。</li>
<li>普通用户通过 Karmada 控制平面在集群中部署在线应用。应用包括数据库实例、服务器实例和配置文件。
  此时，集群故障。客户希望将整个应用程序迁移到另一个合适的集群。在应用迁移过程中，确保业务不中断。</li>
<li>管理员升级集群后，集群中作为基础设施的容器网络和存储设备将发生变化。
  管理员希望在升级集群前将集群中的应用迁移到其他合适的集群中。在迁移过程中，必须持续提供服务。</li>
</ul>
<h2 id="karmada">Karmada 故障恢复示例<a class="headerlink" href="#karmada" title="Permanent link">¶</a></h2>
<p>Karmada 故障恢复支持两种方式：</p>
<ul>
<li><strong>Duplicated</strong> （全量调度策略）。当满足 pp (propagationPolicy) 限制的未调度的候选集群数量不少于调度失败的集群数量时，将调度失败的集群重新调度到候选集群。</li>
<li><strong>Divided</strong> （副本拆分调度策略）。集群故障时，调度器和控制器配合尝试将故障集群副本迁移到其他运行正常的集群。</li>
</ul>
<p>本文以 <strong>Divided</strong> 为例：</p>
<p><img alt="Divided" src="https://docs.daocloud.io/daocloud-docs-images/docs/zh/docs/blogs/images/karmada02.png"/></p>
<ol>
<li>
<p>下载 Karmada 官方 v1.4.2 sourece code 后，使用 <strong>hack/local-up-karmada.sh</strong> ，启动本地的 Karmada。
   启动后，自动纳管了三个工作集群，其中集群 member1 和 member2 使用 push 模式，member3 使用 pull 模式。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$HOME</span>/.kube/karmada.config
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>kubectl<span class="w"> </span>--kubeconfig<span class="w"> </span><span class="nv">$HOME</span>/.kube/karmada.config<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>karmada-apiserver
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>Switched to context "karmada-apiserver".
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>cluster
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>NAME      VERSION   MODE   READY   AGE
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>member1   v1.23.4   Push   True    32m
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>member2   v1.23.4   Push   True    32m
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>member3   v1.23.4   Pull   True    31m
</code></pre></div>
</li>
<li>
<p>在 Karmada 控制平面部署如下的应用配置，可以发现我们定义了一个副本数为 3 的 nginx 的应用，同时定义了一个传播策略。
   传播策略中，使用 <strong>clusterNames</strong> 的方式指定了集群亲和性，需要调度到集群 member1 和 member2 上。
   同时在副本调度策略中，采用副本拆分的方式进行调度，遵循 member1 权重为 1，member2 权重为 2 的静态权重方式进行调度。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="nt">spec</span><span class="p">:</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="nt">labels</span><span class="p">:</span>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="nt">containers</span><span class="p">:</span>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="nn">---</span>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy.karmada.io/v1alpha1</span>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PropagationPolicy</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="nt">metadata</span><span class="p">:</span>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-propagation</span>
<a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="nt">spec</span><span class="p">:</span>
<a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">  </span><span class="nt">resourceSelectors</span><span class="p">:</span>
<a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">  </span><span class="nt">placement</span><span class="p">:</span>
<a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">    </span><span class="nt">clusterAffinity</span><span class="p">:</span>
<a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">    </span><span class="nt">clusterNames</span><span class="p">:</span>
<a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">member1</span>
<a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">member2</span>
<a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">    </span><span class="nt">replicaScheduling</span><span class="p">:</span>
<a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">      </span><span class="nt">replicaDivisionPreference</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Weighted</span>
<a href="#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">      </span><span class="nt">replicaSchedulingType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Divided</span>
<a href="#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">      </span><span class="nt">weightPreference</span><span class="p">:</span>
<a href="#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">        </span><span class="nt">staticWeightList</span><span class="p">:</span>
<a href="#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targetCluster</span><span class="p">:</span>
<a href="#__codelineno-4-41" id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">            </span><span class="nt">clusterNames</span><span class="p">:</span>
<a href="#__codelineno-4-42" id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">member1</span>
<a href="#__codelineno-4-43" id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a href="#__codelineno-4-44" id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targetCluster</span><span class="p">:</span>
<a href="#__codelineno-4-45" id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">            </span><span class="nt">clusterNames</span><span class="p">:</span>
<a href="#__codelineno-4-46" id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">member2</span>
<a href="#__codelineno-4-47" id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">          </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</code></pre></div>
<p>应用下发后，我们将会看到如下结果，集群 member1 上传播了一个副本数为 1 的 deployment，集群 member2 上传播了一个副本数为 2 的 deployment。
合计三个副本，符合我们调度预期。查看控制平面资源信息，发现在控制平面的成员集群对应执行命名空间下，创建了对应的 work，
这里的 work 即是通过传播策略和覆盖策略作用后实际需要在成员集群上传播的资源对象的载体，
同时，资源 deployment 的 rb (ResourceBinding) 中看到，deployment 调度到了集群 member1 和集群 member2。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>failover.yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>deployment.apps/nginx created
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>propagationpolicy.policy.karmada.io/nginx-propagation created
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>deploy,pp
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>deployment.apps/nginx   3/3     3            3           2m
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>NAME                                                    AGE
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>propagationpolicy.policy.karmada.io/nginx-propagation   119s
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>work<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nginx
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>karmada-es-member1   nginx-687f7fb96f                  True      20m
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>karmada-es-member2   nginx-687f7fb96f                  True      20m
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>rb<span class="w"> </span>nginx-deployment<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nn">...</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nt">spec</span><span class="p">:</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="nt">clusters</span><span class="p">:</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">member2</span>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">member2</span>
<a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="nt">resource</span><span class="p">:</span>
<a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">    </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s">"5776"</span>
<a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">530aa301-760a-48a7-ada0-fc3a2112564b</span>
<a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="nn">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>karmadactl<span class="w"> </span>get<span class="w"> </span>po
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>NAME                     CLUSTER   READY   STATUS    RESTARTS   AGE
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>nginx-85b98978db-d7q92   member2   1/1     Running   0          110s
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>nginx-85b98978db-xmbp9   member2   1/1     Running   0          110s
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>nginx-85b98978db-97xbx   member1   1/1     Running   0          110s
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>karmadactl<span class="w"> </span>get<span class="w"> </span>deploy
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>NAME    CLUSTER   READY   UP-TO-DATE   AVAILABLE   AGE     ADOPTION
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a>nginx   member2   2/2     2            2           3m15s   Y
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>nginx   member1   1/1     1            1           3m15s   Y
</code></pre></div>
</li>
<li>
<p>模拟集群发生故障，由于安装集群是使用 kind 启动的，那么我们直接暂停集群 member1 的容器，
   模拟实际情况中，集群由于网络或者集群本身问题，从而在联邦中失联。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a>docker<span class="w"> </span>ps<span class="w"> </span>-a
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a>CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                       NAMES
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a>8794507af450   kindest/node:v1.23.4   "/usr/local/bin/entr…"   52 minutes ago   Up 51 minutes   127.0.0.1:40000-&gt;6443/tcp   member2-control-plane
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a>cc57b0eb54fe   kindest/node:v1.23.4   "/usr/local/bin/entr…"   52 minutes ago   Up 51 minutes   127.0.0.1:35728-&gt;6443/tcp   karmada-host-control-plane
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a>5ac1815cd40e   kindest/node:v1.23.4   "/usr/local/bin/entr…"   52 minutes ago   Up 51 minutes   127.0.0.1:39837-&gt;6443/tcp   member1-control-plane
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a>f5e5f753dcb8   kindest/node:v1.23.4   "/usr/local/bin/entr…"   52 minutes ago   Up 51 minutes   127.0.0.1:33529-&gt;6443/tcp   member3-control-plane
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a>docker<span class="w"> </span>stop<span class="w"> </span>member1-control-plane
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>member1-control-plane
</code></pre></div>
<p>暂停成功，我们再来看一下实际情况，可以发现，集群暂停成功后，控制平面的 resource template 状态依然是 '3/3'，符合整体的预期。
获取成员集群上的 deployment，集群 member1 网络不可达。集群 membe2 上获取到了副本数为 3 的 deployment，故障发生后集群 member2 新增了 1 个副本。
通过查看 Karmada 资源 rb (rersourcebinding) 和 pp(propagationPolicy) 后，可以发现，故障转移后，deployment 的资源绑定只调度到集群 member2。
但是有个问题，从 rb (rersourcebinding) 的配置中，我们可以看到，此时资源未调度到集群 member1，但是此时集群 member1 对应的执行命名空间下仍然存在对应的
work，这是为什么呢？不急，我们来继续进一步探究。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>cluster
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>NAME      VERSION   MODE   READY   AGE
<a href="#__codelineno-22-2" id="__codelineno-22-2" name="__codelineno-22-2"></a>member1   v1.23.4   Push   False   43m
<a href="#__codelineno-22-3" id="__codelineno-22-3" name="__codelineno-22-3"></a>member2   v1.23.4   Push   True    43m
<a href="#__codelineno-22-4" id="__codelineno-22-4" name="__codelineno-22-4"></a>member3   v1.23.4   Pull   True    42m
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>deploy,pp
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
<a href="#__codelineno-24-2" id="__codelineno-24-2" name="__codelineno-24-2"></a>deployment.apps/nginx   3/3     3            3           11m
<a href="#__codelineno-24-3" id="__codelineno-24-3" name="__codelineno-24-3"></a>
<a href="#__codelineno-24-4" id="__codelineno-24-4" name="__codelineno-24-4"></a>NAME                                                    AGE
<a href="#__codelineno-24-5" id="__codelineno-24-5" name="__codelineno-24-5"></a>propagationpolicy.policy.karmada.io/nginx-propagation   11m
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>karmadactl<span class="w"> </span>get<span class="w"> </span>deploy
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-26-1" id="__codelineno-26-1" name="__codelineno-26-1"></a>NAME    CLUSTER   READY   UP-TO-DATE   AVAILABLE   AGE   ADOPTION
<a href="#__codelineno-26-2" id="__codelineno-26-2" name="__codelineno-26-2"></a>nginx   member2   3/3     3            3           12m   Y
<a href="#__codelineno-26-3" id="__codelineno-26-3" name="__codelineno-26-3"></a>error: cluster(member1) is inaccessible, please check authorization or network
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-27-1" id="__codelineno-27-1" name="__codelineno-27-1"></a>karmadactl<span class="w"> </span>get<span class="w"> </span>po
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-28-1" id="__codelineno-28-1" name="__codelineno-28-1"></a>NAME                     CLUSTER   READY   STATUS    RESTARTS   AGE
<a href="#__codelineno-28-2" id="__codelineno-28-2" name="__codelineno-28-2"></a>nginx-85b98978db-8zj5k   member2   1/1     Running   0          3m18s
<a href="#__codelineno-28-3" id="__codelineno-28-3" name="__codelineno-28-3"></a>nginx-85b98978db-d7q92   member2   1/1     Running   0          12m
<a href="#__codelineno-28-4" id="__codelineno-28-4" name="__codelineno-28-4"></a>nginx-85b98978db-xmbp9   member2   1/1     Running   0          12m
<a href="#__codelineno-28-5" id="__codelineno-28-5" name="__codelineno-28-5"></a>error: cluster(member1) is inaccessible, please check authorization or network
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-29-1" id="__codelineno-29-1" name="__codelineno-29-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>rb<span class="w"> </span>nginx-deployment<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-30-1" id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="nn">...</span>
<a href="#__codelineno-30-2" id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="nt">spec</span><span class="p">:</span>
<a href="#__codelineno-30-3" id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="nt">clusters</span><span class="p">:</span>
<a href="#__codelineno-30-4" id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">member2</span>
<a href="#__codelineno-30-5" id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a href="#__codelineno-30-6" id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a href="#__codelineno-30-7" id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="nt">resource</span><span class="p">:</span>
<a href="#__codelineno-30-8" id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a href="#__codelineno-30-9" id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a href="#__codelineno-30-10" id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a href="#__codelineno-30-11" id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a href="#__codelineno-30-12" id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s">"5776"</span>
<a href="#__codelineno-30-13" id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">530aa301-760a-48a7-ada0-fc3a2112564b</span>
<a href="#__codelineno-30-14" id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="nn">...</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-31-1" id="__codelineno-31-1" name="__codelineno-31-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>work<span class="w"> </span>-A<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nginx
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-32-1" id="__codelineno-32-1" name="__codelineno-32-1"></a>karmada-es-member1   nginx-687f7fb96f                  True      30m
<a href="#__codelineno-32-2" id="__codelineno-32-2" name="__codelineno-32-2"></a>karmada-es-member2   nginx-687f7fb96f                  True      30m
</code></pre></div>
<p>将集群状态恢复，模拟集群被运维管理员修复的情况，此时副本的变化又将会如何呢？
可以发现，当故障集群恢复后，集群 member2 上的副本数不变，同时，控制平面在集群
member1 对应执行命名空间下的 work 被删除，集群 member1 上的 deployment 被删除。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-33-1" id="__codelineno-33-1" name="__codelineno-33-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>cluster
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-34-1" id="__codelineno-34-1" name="__codelineno-34-1"></a>NAME      VERSION   MODE   READY   AGE
<a href="#__codelineno-34-2" id="__codelineno-34-2" name="__codelineno-34-2"></a>member1   v1.23.4   Push   True    147m
<a href="#__codelineno-34-3" id="__codelineno-34-3" name="__codelineno-34-3"></a>member2   v1.23.4   Push   True    147m
<a href="#__codelineno-34-4" id="__codelineno-34-4" name="__codelineno-34-4"></a>member3   v1.23.4   Pull   True    146m
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-35-1" id="__codelineno-35-1" name="__codelineno-35-1"></a>karmada<span class="o">(</span>imagesloy,po
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a>NAME                         CLUSTER   READY   STATUS    RESTARTS   AGE
<a href="#__codelineno-36-2" id="__codelineno-36-2" name="__codelineno-36-2"></a>pod/nginx-85b98978db-2p8hn   member2   1/1     Running   0          73m
<a href="#__codelineno-36-3" id="__codelineno-36-3" name="__codelineno-36-3"></a>pod/nginx-85b98978db-7j8xs   member2   1/1     Running   0          73m
<a href="#__codelineno-36-4" id="__codelineno-36-4" name="__codelineno-36-4"></a>pod/nginx-85b98978db-m897g   member2   1/1     Running   0          70m
<a href="#__codelineno-36-5" id="__codelineno-36-5" name="__codelineno-36-5"></a>
<a href="#__codelineno-36-6" id="__codelineno-36-6" name="__codelineno-36-6"></a>NAME                    CLUSTER   READY   UP-TO-DATE   AVAILABLE   AGE
<a href="#__codelineno-36-7" id="__codelineno-36-7" name="__codelineno-36-7"></a>deployment.apps/nginx   member2   3/3     3            3           73m
</code></pre></div>
<p>```shel(images
kubectl get work | grep nginx
<div class="highlight"><pre><span></span><code><a href="#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a>```none
<a href="#__codelineno-37-2" id="__codelineno-37-2" name="__codelineno-37-2"></a>No resources found in default namespace.
</code></pre></div></p>
<p>从以上的示例，我们可以发现，当集群发生故障时，Karmada 会自动调节其余成员集群上的副本，
从而来满足用户整体的副本期望，从而达到集群级别的故障恢复。当故障集群恢复后，转移的副本会保持不变，
原有调度集群上资源会被删除，资源不会调度回故障的集群。</p>
</li>
</ol>
<h2 id="karmada_1">Karmada 故障恢复实现原理<a class="headerlink" href="#karmada_1" title="Permanent link">¶</a></h2>
<p>在多集群场景下，用户应用可能部署在多个集群中，以提高业务的高可用性。
在 Karmada 中，当集群发生故障或用户不想继续在集群上运行应用时，集群状态将被标记为不可用，并添加两个污点。
(images(images
检测到集群故障后，控制器将从故障集群中移除应用。然后，被移除的应用将被调度到满足要求的其他集群。
这样可以实现故障转移，保证用户业务的高可用性和连续性。</p>
<p><img alt="failover" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada03.png"/></p>
<blockquote>
<p>图源：Karmada 官方文档 <a href="https://karmada.io">https://karmada.io</a></p>
</blockquote>
<p>如上图，用户在 Karmada 中加入了三个集群: member1、member2 和 member3。
部署一个名为 foo 的 deployment，它有两个副本，在 Karmada 控制平面上创建。
通过使用 pp (PropagationPolicy) 将 deployement 传播到集群 member1 和 member2。</p>
<p>当集群 member1 发生故障时，如果是副本拆分策略，集群 member1 上的 Pod 将被清除并迁移到满足要求的集群 member2。
如果是全量策略，集群 member1 上的 deployment 将会被移除并迁移到满足要求的集群 member3。</p>
<p>Karmada 实现故障转移，主要由 karmada-controller-manager 中的 6 个控制器和 karmada-scheduler 参与完成。</p>
<p><img alt="failover" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada04.png"/></p>
<ol>
<li>clusterStatus controller：感知集群状态，并将集群状态写入到控制平面的 cluster 资源对象的状态中。</li>
<li>cluster controller：在控制平面创建执行命名空间（这里的执行命名空间指的是 Karmada
   会在控制平面为每一个成员集群创建一个具有特殊命名规则的命名空间，该命名空间用于存放 work ），根据 conditions 判断是否需要为集群打上污点。</li>
<li>taint-manager controller：根据集群污点，传播策略中容忍的集群污点，对比计算，确定是否要将集群上的资源驱逐。</li>
<li>karmada-scheduler：根据传播策略和集群情况，为资源选择最佳的调度集群。</li>
<li>gracefulEviction controller：保证在新的集群上的资源状态健康后，再移除驱逐集群上的资源对象。</li>
<li>binding controller：根据调度结果，应用传播策略中的规则，在控制平面集群对应执行命名空间下创建 work，
   聚合 work 状态，更新 rb(ResourceBinding) 和 resource template 状态。</li>
<li>execution controller：根据成员集群对应执行命名空间下的 work, 在成员集群中创建资源。</li>
</ol>
<p>接下来看一下每个控制器和调度器，在集群故障恢复的场景中，分别承担了什么样的能力。</p>
<h3 id="clusterstatus-controller">clusterStatus controller<a class="headerlink" href="#clusterstatus-controller" title="Permanent link">¶</a></h3>
<p><img alt="clusterStatus controller" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada05.png"/></p>
<p>clusterStatus controller 主要用于同步集群实际状态。当集群无法访问时，clusterStatus controller
就会感知到集群状态处于非在线状态，此时便会更新控制平面的 cluster 资源对象的状态，修改 conditions 中
type 为 Ready 的 condition 状态为 ‘False’， 以下为主要实现代码。</p>
<p>首先，通过访问成员集群 kube-apiserver 的 ‘/readyz’ 和 ‘/healthz’，获取到成员集群的在线状态和健康状态。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-38-1" id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">getClusterHealthStatus</span><span class="p">(</span><span class="nx">clusterClient</span><span class="w"> </span><span class="o">*</span><span class="nx">util</span><span class="p">.</span><span class="nx">ClusterClient</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">online</span><span class="p">,</span><span class="w"> </span><span class="nx">healthy</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-38-2" id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w">    </span><span class="nx">healthStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">healthEndpointCheck</span><span class="p">(</span><span class="nx">clusterClient</span><span class="p">.</span><span class="nx">KubeClient</span><span class="p">,</span><span class="w"> </span><span class="s">"/readyz"</span><span class="p">)</span>
<a href="#__codelineno-38-3" id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">healthStatus</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-38-4" id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">        </span><span class="c1">// do health check with healthz endpoint if the readyz endpoint is not installed in member cluster</span>
<a href="#__codelineno-38-5" id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">        </span><span class="nx">healthStatus</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">healthEndpointCheck</span><span class="p">(</span><span class="nx">clusterClient</span><span class="p">.</span><span class="nx">KubeClient</span><span class="p">,</span><span class="w"> </span><span class="s">"/healthz"</span><span class="p">)</span>
<a href="#__codelineno-38-6" id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-38-7" id="__codelineno-38-7" name="__codelineno-38-7"></a>
<a href="#__codelineno-38-8" id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-38-9" id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"Failed to do cluster health check for cluster %v, err is : %v "</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterClient</span><span class="p">.</span><span class="nx">ClusterName</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-38-10" id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span>
<a href="#__codelineno-38-11" id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-38-12" id="__codelineno-38-12" name="__codelineno-38-12"></a>
<a href="#__codelineno-38-13" id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">healthStatus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-38-14" id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Infof</span><span class="p">(</span><span class="s">"Member cluster %v isn't healthy"</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterClient</span><span class="p">.</span><span class="nx">ClusterName</span><span class="p">)</span>
<a href="#__codelineno-38-15" id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span>
<a href="#__codelineno-38-16" id="__codelineno-38-16" name="__codelineno-38-16"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-38-17" id="__codelineno-38-17" name="__codelineno-38-17"></a>
<a href="#__codelineno-38-18" id="__codelineno-38-18" name="__codelineno-38-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span>
<a href="#__codelineno-38-19" id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="p">}</span>
</code></pre></div>
<p>其次，根据在线状态和健康状态初始化 conditions。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-39-1" id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">generateReadyCondition</span><span class="p">(</span><span class="nx">imagesalthy</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Condition</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-39-2" id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">online</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-39-3" id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">NewCondition</span><span class="p">(</span><span class="nx">clusterv1alpha1</span><span class="p">.</span><span class="nx">ClusterConditionReady</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterNotReachableReason</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterNotReachableMsg</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionFalse</span><span class="p">)</span>
<a href="#__codelineno-39-4" id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-39-5" id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">healthy</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-39-6" id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">NewCondition</span><span class="p">(</span><span class="nx">clusterv1alpha1</span><span class="p">.</span><span class="nx">ClusterConditionReady</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterNotReady</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterUnhealthy</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionFalse</span><span class="p">)</span>
<a href="#__codelineno-39-7" id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-39-8" id="__codelineno-39-8" name="__codelineno-39-8"></a>
<a href="#__codelineno-39-9" id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">NewCondition</span><span class="p">(</span><span class="nx">clusterv1alpha1</span><span class="p">.</span><span class="nx">ClusterConditionReady</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterReady</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterHealthy</span><span class="p">,</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionTrue</span><span class="p">)</span>
<a href="#__codelineno-39-10" id="__codelineno-39-10" name="__codelineno-39-10"></a><span class="p">}</span>
</code></pre></div>
<p>最后，如果集群已经下线，此时初始化的 condition 状态不为 ‘True’，
则认为需要更新 cluster 资源对象的 condiitions。
conditions 中 type 为 Ready 的 condition 状态将会被修改为 ‘False’，然后返回。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-40-1" id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="nx">online</span><span class="p">,</span><span class="w"> </span><span class="nx">healthy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getClusterHealthStatus</span><span class="p">(</span><span class="nx">clusterClient</span><span class="p">)</span>
<a href="#__codelineno-40-2" id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="nx">observedReadyCondition</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">generateReadyCondition</span><span class="p">(</span><span class="nx">online</span><span class="p">,</span><span class="w"> </span><span class="nx">healthy</span><span class="p">)</span>
<a href="#__codelineno-40-3" id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="nx">readyCondition</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">clusterConditionCache</span><span class="p">.</span><span class="nx">thresholdAdjustedReadyCondition</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">observedReadyCondition</span><span class="p">)</span>
<a href="#__codelineno-40-4" id="__codelineno-40-4" name="__codelineno-40-4"></a>
<a href="#__codelineno-40-5" id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="c1">// cluster is offline after retry timeout, update cluster status immediately and return.</span>
<a href="#__codelineno-40-6" id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">online</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">readyCondition</span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionTrue</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-40-7" id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w">    </span><span class="nx">klog</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">Infof</span><span class="p">(</span><span class="s">"Cluster(%s) still offline after %s, ensuring offline is set."</span><span class="p">,</span>
<a href="#__codelineno-40-8" id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w">        </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">ClusterFailureThreshold</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span>
<a href="#__codelineno-40-9" id="__codelineno-40-9" name="__codelineno-40-9"></a><span class="w">    </span><span class="nx">setTransitionTime</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">,</span><span class="w"> </span><span class="nx">readyCondition</span><span class="p">)</span>
<a href="#__codelineno-40-10" id="__codelineno-40-10" name="__codelineno-40-10"></a><span class="w">    </span><span class="nx">meta</span><span class="p">.</span><span class="nx">SetStatusCondition</span><span class="p">(</span><span class="err">¤</span><span class="nx">tClusterStatus</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">readyCondition</span><span class="p">)</span>
<a href="#__codelineno-40-11" id="__codelineno-40-11" name="__codelineno-40-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">updateStatusIfNeeded</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="nx">currentClusterStatus</span><span class="p">)</span>
<a href="#__codelineno-40-12" id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="p">}</span>
</code></pre></div>
<h3 id="cluster-controller">cluster controller<a class="headerlink" href="#cluster-controller" title="Permanent link">¶</a></h3>
<p><img alt="clusterStatus controller" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada06.png"/></p>
<p>cluster conntroller 会根据集群当前状态下的 conditions，判断是否需要为集群打上不可调度和不可执行的污点。
以下代码为核心实现逻辑，当 conditions 中 type 为 Ready 的 condition 状态为 'False' 时，
执行 UpdateClusterControllerTaint 函数添加 effect 为 NoSchedule 污点。
此污点并不会触发驱逐操作。想要触发驱逐操作，你还需要将 NoExecute 作为污点添加到 <a href="#taint-manager-controller">taint-manager</a>。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-41-1" id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">Controller</span><span class="p">)</span><span class="w"> </span><span class="nx">taintClusterByCondition</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">*</span><span class="nx">clusterv1alpha1</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-2" id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="w">    </span><span class="nx">currentReadyCondition</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">meta</span><span class="p">.</span><span class="nx">FindStatusCondition</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Conditions</span><span class="p">,</span><span class="w"> </span><span class="nx">clusterv1alpha1</span><span class="p">.</span><span class="nx">ClusterConditionReady</span><span class="p">)</span>
<a href="#__codelineno-41-3" id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<a href="#__codelineno-41-4" id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">currentReadyCondition</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-5" id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">currentReadyCondition</span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-6" id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionFalse</span><span class="p">:</span>
<a href="#__codelineno-41-7" id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="w">            </span><span class="c1">// Add NotReadyTaintTemplateForSched taint immediately.</span>
<a href="#__codelineno-41-8" id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">utilhelper</span><span class="p">.</span><span class="nx">UpdateClusterControllerTaint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Taint</span><span class="p">{</span><span class="nx">NotReadyTaintTemplateForSched</span><span class="p">},</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Taint</span><span class="p">{</span><span class="nx">UnreachableTaintTemplateForSched</span><span class="p">},</span><span class="w"> </span><span class="nx">cluster</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-9" id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="w">                </span><span class="nx">klog</span><span class="p">.</span><span class="nx">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">"Failed to instantly update UnreachableTaintForSched to NotReadyTaintForSched, will try again in the next cycle."</span><span class="p">,</span><span class="w"> </span><span class="s">"cluster"</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<a href="#__codelineno-41-10" id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-41-11" id="__codelineno-41-11" name="__codelineno-41-11"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionUnknown</span><span class="p">:</span>
<a href="#__codelineno-41-12" id="__codelineno-41-12" name="__codelineno-41-12"></a><span class="w">            </span><span class="c1">// Add UnreachableTaintTemplateForSched taint immediately.</span>
<a href="#__codelineno-41-13" id="__codelineno-41-13" name="__codelineno-41-13"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">utilhelper</span><span class="p">.</span><span class="nx">UpdateClusterControllerTaint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Taint</span><span class="p">{</span><span class="nx">UnreachableTaintTemplateForSched</span><span class="p">},</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Taint</span><span class="p">{</span><span class="nx">NotReadyTaintTemplateForSched</span><span class="p">},</span><span class="w"> </span><span class="nx">cluster</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-14" id="__codelineno-41-14" name="__codelineno-41-14"></a><span class="w">                </span><span class="nx">klog</span><span class="p">.</span><span class="nx">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">"Failed to instantly swap NotReadyTaintForSched to UnreachableTaintForSched, will try again in the next cycle."</span><span class="p">,</span><span class="w"> </span><span class="s">"cluster"</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<a href="#__codelineno-41-15" id="__codelineno-41-15" name="__codelineno-41-15"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-41-16" id="__codelineno-41-16" name="__codelineno-41-16"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ConditionTrue</span><span class="p">:</span>
<a href="#__codelineno-41-17" id="__codelineno-41-17" name="__codelineno-41-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">utilhelper</span><span class="p">.</span><span class="nx">UpdateClusterControllerTaint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Taint</span><span class="p">{</span><span class="nx">NotReadyTaintTemplateForSched</span><span class="p">,</span><span class="w"> </span><span class="nx">UnreachableTaintTemplateForSched</span><span class="p">},</span><span class="w"> </span><span class="nx">cluster</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-18" id="__codelineno-41-18" name="__codelineno-41-18"></a><span class="w">                </span><span class="nx">klog</span><span class="p">.</span><span class="nx">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">"Failed to remove schedule taints from cluster, will retry in next iteration."</span><span class="p">,</span><span class="w"> </span><span class="s">"cluster"</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<a href="#__codelineno-41-19" id="__codelineno-41-19" name="__codelineno-41-19"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-41-20" id="__codelineno-41-20" name="__codelineno-41-20"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-41-21" id="__codelineno-41-21" name="__codelineno-41-21"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-22" id="__codelineno-41-22" name="__codelineno-41-22"></a><span class="w">        </span><span class="c1">// Add NotReadyTaintTemplateForSched taint immediately.</span>
<a href="#__codelineno-41-23" id="__codelineno-41-23" name="__codelineno-41-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">utilhelper</span><span class="p">.</span><span class="nx">UpdateClusterControllerTaint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Taint</span><span class="p">{</span><span class="nx">NotReadyTaintTemplateForSched</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-41-24" id="__codelineno-41-24" name="__codelineno-41-24"></a><span class="w">            </span><span class="nx">klog</span><span class="p">.</span><span class="nx">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">"Failed to add a NotReady taint to the newly added cluster, will try again in the next cycle."</span><span class="p">,</span><span class="w"> </span><span class="s">"cluster"</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<a href="#__codelineno-41-25" id="__codelineno-41-25" name="__codelineno-41-25"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-41-26" id="__codelineno-41-26" name="__codelineno-41-26"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-41-27" id="__codelineno-41-27" name="__codelineno-41-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-41-28" id="__codelineno-41-28" name="__codelineno-41-28"></a><span class="p">}</span>
</code></pre></div>
<h3 id="taint-manager-controller">taint-manager controller<a class="headerlink" href="#taint-manager-controller" title="Permanent link">¶</a></h3>
<p><img alt="clusterStatus controller" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada07.png"/></p>
<p>taint-manager controller 控制器随 cluster controller 同步启动，可参数配置是否启动，默认启动。
它感知 cluster 资源对象的变更事件，当感知到集群拥有 effect 为 NoExecute 的污点时，
会获取到该集群上的所有命名空间级别和集群级别的 rb (ResourceBinding)，然后放入对应的驱逐处理队列。
驱逐处理消费者（worker）会判断获取到 rb(ResourceBinding) 对应的 pp (PropagationPolicy)，看
pp (PropagationPolicy) 中是否存在集群污点容忍，如果 pp (PropagationPolicy) 中的集群污点容忍和集群污点匹配，
那么直接跳过，认为该集群上的资源不需要驱逐。否则认为需要驱逐。如果需要驱逐，那么此时会判断是否开启了优雅驱逐，
优雅驱逐默认开启，为 rb (ResourceBinding) 对象写入优雅驱逐任务，即 rb.spec.gracefulEvictionTasks 中增加一条优雅驱逐任务。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-42-1" id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="nx">needEviction</span><span class="p">,</span><span class="w"> </span><span class="nx">tolerationTime</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">needEviction</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="nx">binding</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">)</span>
<a href="#__codelineno-42-2" id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-42-3" id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="w">    </span><span class="nx">klog</span><span class="p">.</span><span class="nx">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">"Failed to check if binding needs eviction"</span><span class="p">,</span><span class="w"> </span><span class="s">"binding"</span><span class="p">,</span><span class="w"> </span><span class="nx">fedKey</span><span class="p">.</span><span class="nx">ClusterWideKey</span><span class="p">.</span><span class="nx">NamespaceKey</span><span class="p">())</span>
<a href="#__codelineno-42-4" id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-42-5" id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="p">}</span>
<a href="#__codelineno-42-6" id="__codelineno-42-6" name="__codelineno-42-6"></a>
<a href="#__codelineno-42-7" id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="c1">// Case 1: Need eviction now.</span>
<a href="#__codelineno-42-8" id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="c1">// Case 2: Need eviction after toleration time. If time is up, do eviction right now.</span>
<a href="#__codelineno-42-9" id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="c1">// Case 3: Tolerate forever, we do nothing.</span>
<a href="#__codelineno-42-10" id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="k">if</span><span class="w"> </span><span class="nx">needEviction</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">tolerationTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-42-11" id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="w">    </span><span class="c1">// update final result to evict the target cluster</span>
<a href="#__codelineno-42-12" id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">features</span><span class="p">.</span><span class="nx">FeatureGate</span><span class="p">.</span><span class="nx">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">GracefulEviction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-42-13" id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="w">        </span><span class="nx">binding</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">GracefulEvictCluster</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">EvictionProducerTaintManager</span><span class="p">,</span><span class="w"> </span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">EvictionReasonTaintUntolerated</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span>
<a href="#__codelineno-42-14" id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-42-15" id="__codelineno-42-15" name="__codelineno-42-15"></a><span class="w">        </span><span class="nx">binding</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">RemoveCluster</span><span class="p">(</span><span class="nx">cluster</span><span class="p">)</span>
<a href="#__codelineno-42-16" id="__codelineno-42-16" name="__codelineno-42-16"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-42-17" id="__codelineno-42-17" name="__codelineno-42-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">Update</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span><span class="w"> </span><span class="nx">binding</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-42-18" id="__codelineno-42-18" name="__codelineno-42-18"></a><span class="w">        </span><span class="nx">helper</span><span class="p">.</span><span class="nx">EmitClusterEvictionEventForResourceBinding</span><span class="p">(</span><span class="nx">binding</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-42-19" id="__codelineno-42-19" name="__codelineno-42-19"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">ErrorS</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="s">"Failed to update binding"</span><span class="p">,</span><span class="w"> </span><span class="s">"binding"</span><span class="p">,</span><span class="w"> </span><span class="nx">klog</span><span class="p">.</span><span class="nx">KObj</span><span class="p">(</span><span class="nx">binding</span><span class="p">))</span>
<a href="#__codelineno-42-20" id="__codelineno-42-20" name="__codelineno-42-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-42-21" id="__codelineno-42-21" name="__codelineno-42-21"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-42-22" id="__codelineno-42-22" name="__codelineno-42-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">features</span><span class="p">.</span><span class="nx">FeatureGate</span><span class="p">.</span><span class="nx">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">GracefulEviction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-42-23" id="__codelineno-42-23" name="__codelineno-42-23"></a><span class="w">        </span><span class="nx">helper</span><span class="p">.</span><span class="nx">EmitClusterEvictionEventForResourceBinding</span><span class="p">(</span><span class="nx">binding</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">,</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<a href="#__codelineno-42-24" id="__codelineno-42-24" name="__codelineno-42-24"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-42-25" id="__codelineno-42-25" name="__codelineno-42-25"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">tolerationTime</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-42-26" id="__codelineno-42-26" name="__codelineno-42-26"></a><span class="w">    </span><span class="nx">tc</span><span class="p">.</span><span class="nx">bindingEvictionWorker</span><span class="p">.</span><span class="nx">AddAfter</span><span class="p">(</span><span class="nx">fedKey</span><span class="p">,</span><span class="w"> </span><span class="nx">tolerationTime</span><span class="p">)</span>
<a href="#__codelineno-42-27" id="__codelineno-42-27" name="__codelineno-42-27"></a><span class="p">}</span>
</code></pre></div>
<p>可以发现，写入驱逐任务时，会将优雅驱逐任务对应的集群，从 rb.spec.clusters 中移除，也就是会修改调度结果
（这里需要特别说明一下，调度结果就是 Karmada 调度器根据传播策略和集群情况为资源选择的调度分发集群，
调度结果会记录在 rb (ResourceBinding) 的 spec.clusters 属性中）。
也就是说由于集群故障，会触发调度器重新调度，资源应该从故障的集群上驱逐，在新的集群上创建。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-43-1" id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="c1">// This function no-(images cluster does not exist.</span>
<a href="#__codelineno-43-2" id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">ResourceBindingSpec</span><span class="p">)</span><span class="w"> </span><span class="nx">GracefulEvictCluster</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">producer</span><span class="p">,</span><span class="w"> </span><span class="nx">reason</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-43-3" id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="w">   </span><span class="c1">// find the cluster index</span>
<a href="#__codelineno-43-4" id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="kt">int</span>
<a href="#__codelineno-43-5" id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-43-6" id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-43-7" id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="w">         </span><span class="k">break</span>
<a href="#__codelineno-43-8" id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="w">      </span><span class="p">}</span>
<a href="#__codelineno-43-9" id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="w">   </span><span class="p">}</span>
<a href="#__codelineno-43-10" id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="w">   </span><span class="c1">// not found, do nothing</span>
<a href="#__codelineno-43-11" id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-43-12" id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="w">      </span><span class="k">return</span>
<a href="#__codelineno-43-13" id="__codelineno-43-13" name="__codelineno-43-13"></a><span class="w">   </span><span class="p">}</span>
<a href="#__codelineno-43-14" id="__codelineno-43-14" name="__codelineno-43-14"></a>
<a href="#__codelineno-43-15" id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="w">   </span><span class="c1">// build eviction task</span>
<a href="#__codelineno-43-16" id="__codelineno-43-16" name="__codelineno-43-16"></a><span class="w">   </span><span class="nx">evictingCluster</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">DeepCopy</span><span class="p">()</span>
<a href="#__codelineno-43-17" id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="w">   </span><span class="nx">evictionTask</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">GracefulEvictionTask</span><span class="p">{</span>
<a href="#__codelineno-43-18" id="__codelineno-43-18" name="__codelineno-43-18"></a><span class="w">      </span><span class="nx">FromCluster</span><span class="p">:</span><span class="w"> </span><span class="nx">evictingCluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
<a href="#__codelineno-43-19" id="__codelineno-43-19" name="__codelineno-43-19"></a><span class="w">      </span><span class="nx">Reason</span><span class="p">:</span><span class="w">      </span><span class="nx">reason</span><span class="p">,</span>
<a href="#__codelineno-43-20" id="__codelineno-43-20" name="__codelineno-43-20"></a><span class="w">      </span><span class="nx">Message</span><span class="p">:</span><span class="w">     </span><span class="nx">message</span><span class="p">,</span>
<a href="#__codelineno-43-21" id="__codelineno-43-21" name="__codelineno-43-21"></a><span class="w">      </span><span class="nx">Producer</span><span class="p">:</span><span class="w">    </span><span class="nx">producer</span><span class="p">,</span>
<a href="#__codelineno-43-22" id="__codelineno-43-22" name="__codelineno-43-22"></a><span class="w">   </span><span class="p">}</span>
<a href="#__codelineno-43-23" id="__codelineno-43-23" name="__codelineno-43-23"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="nx">evictingCluster</span><span class="p">.</span><span class="nx">Replicas</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-43-24" id="__codelineno-43-24" name="__codelineno-43-24"></a><span class="w">      </span><span class="nx">evictionTask</span><span class="p">.</span><span class="nx">Replicas</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">evictingCluster</span><span class="p">.</span><span class="nx">Replicas</span>
<a href="#__codelineno-43-25" id="__codelineno-43-25" name="__codelineno-43-25"></a><span class="w">   </span><span class="p">}</span>
<a href="#__codelineno-43-26" id="__codelineno-43-26" name="__codelineno-43-26"></a>
<a href="#__codelineno-43-27" id="__codelineno-43-27" name="__codelineno-43-27"></a><span class="w">   </span><span class="nx">s</span><span class="p">.</span><span class="nx">GracefulEvictionTasks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">GracefulEvictionTasks</span><span class="p">,</span><span class="w"> </span><span class="nx">evictionTask</span><span class="p">)</span>
<a href="#__codelineno-43-28" id="__codelineno-43-28" name="__codelineno-43-28"></a><span class="w">   </span><span class="nx">s</span><span class="p">.</span><span class="nx">Clusters</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">[:</span><span class="nx">i</span><span class="p">],</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
<a href="#__codelineno-43-29" id="__codelineno-43-29" name="__codelineno-43-29"></a><span class="p">}</span>
</code></pre></div>
<h3 id="karmada-scheduler">Karmada scheduler<a class="headerlink" href="#karmada-scheduler" title="Permanent link">¶</a></h3>
<p><img alt="Karmada scheduler" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada08.png"/></p>
<p>Karmada scheduler，如果调度的目标副本和期望的目标副本不等，也就是当 rb.spec.clusters（资源调度集群结果）下所有的副本之和不等于
rb.spec.replicas（资源期望副本）时，调度器认为这是一次扩容或者缩容操作，从而触发重调度操作。
而在 taint-manager controller 中，由于集群故障，资源从故障集群上驱逐了，taint-manger controller
修改了调度结果，移除了 rb.spec.clusters 下的一个集群，导致 rb.spec.clusters
下所有的副本之和小于 rb.spec.replicas，所以这是一次扩容操作。</p>
<p>这里是否需要重新调度的判断，核心逻辑为 ‘replicasSum != bindingSpec.Replicas’。
移除了调度结果中的集群 member1 的调度结果，所以此时 replicasSum 值为 2，
但是 bindingSpec.Replicas 值为 3，两者不等所以函数返回值为真。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-44-1" id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="c1">// IsBindingReplicasChanged will check if the sum of replicas is different from the replicas of object</span>
<a href="#__codelineno-44-2" id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">IsBindingReplicasChanged</span><span class="p">(</span><span class="nx">bindingSpec</span><span class="w"> </span><span class="o">*</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">ResourceBindingSpec</span><span class="p">,</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="o">*</span><span class="nx">policyv1alpha1</span><span class="p">.</span><span class="nx">ReplicaSchedulingStrategy</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-44-3" id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">strategy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-44-4" id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<a href="#__codelineno-44-5" id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-44-6" id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">strategy</span><span class="p">.</span><span class="nx">ReplicaSchedulingType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">policyv1alpha1</span><span class="p">.</span><span class="nx">ReplicaSchedulingTypeDuplicated</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-44-7" id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">targetCluster</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">Clusters</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-44-8" id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">targetCluster</span><span class="p">.</span><span class="nx">Replicas</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">Replicas</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-44-9" id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<a href="#__codelineno-44-10" id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-44-11" id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-44-12" id="__codelineno-44-12" name="__codelineno-44-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<a href="#__codelineno-44-13" id="__codelineno-44-13" name="__codelineno-44-13"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-44-14" id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">strategy</span><span class="p">.</span><span class="nx">ReplicaSchedulingType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">policyv1alpha1</span><span class="p">.</span><span class="nx">ReplicaSchedulingTypeDivided</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-44-15" id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="w">        </span><span class="nx">replicasSum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">GetSumOfReplicas</span><span class="p">(</span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">)</span>
<a href="#__codelineno-44-16" id="__codelineno-44-16" name="__codelineno-44-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">replicasSum</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">Replicas</span>
<a href="#__codelineno-44-17" id="__codelineno-44-17" name="__codelineno-44-17"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-44-18" id="__codelineno-44-18" name="__codelineno-44-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<a href="#__codelineno-44-19" id="__codelineno-44-19" name="__codelineno-44-19"></a><span class="p">}</span>
</code></pre></div>
<p>由于函数 IsBindingReplicasChanged 返回为真，并且设置了 ReplicaScheduling，则会执行重调度操作。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-45-1" id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">rb</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Placement</span><span class="p">.</span><span class="nx">ReplicaScheduling</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">IsBindingReplicasChanged</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span><span class="w"> </span><span class="nx">rb</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Placement</span><span class="p">.</span><span class="nx">ReplicaScheduling</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-45-2" id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="w">    </span><span class="c1">// binding replicas changed, need reschedule</span>
<a href="#__codelineno-45-3" id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">    </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Infof</span><span class="p">(</span><span class="s">"Reschedule ResourceBinding(%s/%s) as replicas scaled down or scaled up"</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span>
<a href="#__codelineno-45-4" id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">scheduleResourceBinding</span><span class="p">(</span><span class="nx">rb</span><span class="p">)</span>
<a href="#__codelineno-45-5" id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="w">    </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">BindingSchedule</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">ScaleSchedule</span><span class="p">),</span><span class="w"> </span><span class="nx">utilmetrics</span><span class="p">.</span><span class="nx">DurationInSeconds</span><span class="p">(</span><span class="nx">start</span><span class="p">),</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-45-6" id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-45-7" id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="p">}</span>
</code></pre></div>
<p>在重调度逻辑中，由于集群 member1 存在污点，所以会被调度插件过滤掉，集群 member3 没有被集群亲和性选中。结果，只有 member2 满足要求。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-46-1" id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="c1">// Filter checks if the given tolerations in placement tolerate cluster's taints.</span>
<a href="#__codelineno-46-2" id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="o">*</span><span class="nx">TaintToleration</span><span class="p">)</span><span class="w"> </span><span class="nx">Filter</span><span class="p">(</span>
<a href="#__codelineno-46-3" id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
<a href="#__codelineno-46-4" id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="nx">bindingSpec</span><span class="w"> </span><span class="o">*</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">ResourceBindingSpec</span><span class="p">,</span>
<a href="#__codelineno-46-5" id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="o">*</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">ResourceBindingStatus</span><span class="p">,</span>
<a href="#__codelineno-46-6" id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w">    </span><span class="nx">cluster</span><span class="w"> </span><span class="o">*</span><span class="nx">clusterv1alpha1</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">,</span>
<a href="#__codelineno-46-7" id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Result</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-46-8" id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="w">    </span><span class="c1">// skip the filter if the cluster is already in the list of scheduling results,</span>
<a href="#__codelineno-46-9" id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w">    </span><span class="c1">// if the workload referencing by the binding can't tolerate the taint,</span>
<a href="#__codelineno-46-10" id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w">    </span><span class="c1">// the taint-manager will evict it after a graceful period.</span>
<a href="#__codelineno-46-11" id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">TargetContains</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-46-12" id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">framework</span><span class="p">.</span><span class="nx">NewResult</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Success</span><span class="p">)</span>
<a href="#__codelineno-46-13" id="__codelineno-46-13" name="__codelineno-46-13"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-46-14" id="__codelineno-46-14" name="__codelineno-46-14"></a>
<a href="#__codelineno-46-15" id="__codelineno-46-15" name="__codelineno-46-15"></a><span class="w">    </span><span class="nx">filterPredicate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Taint</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-46-16" id="__codelineno-46-16" name="__codelineno-46-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">Effect</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">TaintEffectNoSchedule</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">Effect</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">TaintEffectNoExecute</span>
<a href="#__codelineno-46-17" id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-46-18" id="__codelineno-46-18" name="__codelineno-46-18"></a>
<a href="#__codelineno-46-19" id="__codelineno-46-19" name="__codelineno-46-19"></a><span class="w">    </span><span class="nx">taint</span><span class="p">,</span><span class="w"> </span><span class="nx">isUntolerated</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">v1helper</span><span class="p">.</span><span class="nx">FindMatchingUntoleratedTaint</span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Taints</span><span class="p">,</span><span class="w"> </span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">Placement</span><span class="p">.</span><span class="nx">ClusterTolerations</span><span class="p">,</span><span class="w"> </span><span class="nx">filterPredicate</span><span class="p">)</span>
<a href="#__codelineno-46-20" id="__codelineno-46-20" name="__codelineno-46-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">isUntolerated</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-46-21" id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">framework</span><span class="p">.</span><span class="nx">NewResult</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Success</span><span class="p">)</span>
<a href="#__codelineno-46-22" id="__codelineno-46-22" name="__codelineno-46-22"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-46-23" id="__codelineno-46-23" name="__codelineno-46-23"></a>
<a href="#__codelineno-46-24" id="__codelineno-46-24" name="__codelineno-46-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">framework</span><span class="p">.</span><span class="nx">NewResult</span><span class="p">(</span><span class="nx">framework</span><span class="p">.</span><span class="nx">Unschedulable</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">"cluster(s) had untolerated taint {%s}"</span><span class="p">,</span><span class="w"> </span><span class="nx">taint</span><span class="p">.</span><span class="nx">ToString</span><span class="p">()))</span>
<a href="#__codelineno-46-25" id="__codelineno-46-25" name="__codelineno-46-25"></a><span class="p">}</span>
</code></pre></div>
<p>在计算调度副本时，由于设置了静态权重，所以要以静态权重方式
（静态权重方式是指，根据管理员设定的比例对副本进行拆分，举例，如果期望副本总数为 9，
集群 member1 静态权重为 1，集群 member2 静态权重为 2，那么集群 member1 上的副本计算方式是 9*⅓=3，
集群 member2 上的副本计算方式为 9*⅔=6）进行副本拆分。但是，因为只有一个集群满足要求，
所以在设置集群调度副本时，集群 member2 的副本调度结果为 3，所以调度器会将 rb.spec.clusters
（资源调度集群结果）下的集群 member2 上的副本调度结果由 2 修改为 3。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-47-1" id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="c1">// TakeByWeight divide replicas by a weight list and merge the result into previous result.</span>
<a href="#__codelineno-47-2" id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="o">*</span><span class="nx">Dispenser</span><span class="p">)</span><span class="w"> </span><span class="nx">TakeByWeight</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">ClusterWeightInfoList</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-47-3" id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-47-4" id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w">        </span><span class="k">return</span>
<a href="#__codelineno-47-5" id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-47-6" id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="w">    </span><span class="nx">sum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">GetWeightSum</span><span class="p">()</span>
<a href="#__codelineno-47-7" id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">sum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-47-8" id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">        </span><span class="k">return</span>
<a href="#__codelineno-47-9" id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-47-10" id="__codelineno-47-10" name="__codelineno-47-10"></a>
<a href="#__codelineno-47-11" id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="w">    </span><span class="nx">sort</span><span class="p">.</span><span class="nx">Sort</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
<a href="#__codelineno-47-12" id="__codelineno-47-12" name="__codelineno-47-12"></a>
<a href="#__codelineno-47-13" id="__codelineno-47-13" name="__codelineno-47-13"></a><span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">TargetCluster</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">w</span><span class="p">.</span><span class="nx">Len</span><span class="p">())</span>
<a href="#__codelineno-47-14" id="__codelineno-47-14" name="__codelineno-47-14"></a><span class="w">    </span><span class="nx">remain</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">NumReplicas</span>
<a href="#__codelineno-47-15" id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">w</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-47-16" id="__codelineno-47-16" name="__codelineno-47-16"></a><span class="w">        </span><span class="nx">replicas</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">int32</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">Weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">int64</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">NumReplicas</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">sum</span><span class="p">)</span>
<a href="#__codelineno-47-17" id="__codelineno-47-17" name="__codelineno-47-17"></a><span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">TargetCluster</span><span class="p">{</span>
<a href="#__codelineno-47-18" id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="w">            </span><span class="nx">Name</span><span class="p">:</span><span class="w">     </span><span class="nx">info</span><span class="p">.</span><span class="nx">ClusterName</span><span class="p">,</span>
<a href="#__codelineno-47-19" id="__codelineno-47-19" name="__codelineno-47-19"></a><span class="w">            </span><span class="nx">Replicas</span><span class="p">:</span><span class="w"> </span><span class="nx">replicas</span><span class="p">,</span>
<a href="#__codelineno-47-20" id="__codelineno-47-20" name="__codelineno-47-20"></a><span class="w">        </span><span class="p">})</span>
<a href="#__codelineno-47-21" id="__codelineno-47-21" name="__codelineno-47-21"></a><span class="w">        </span><span class="nx">remain</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="nx">replicas</span>
<a href="#__codelineno-47-22" id="__codelineno-47-22" name="__codelineno-47-22"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-47-23" id="__codelineno-47-23" name="__codelineno-47-23"></a><span class="w">    </span><span class="c1">// TODO(Garrybest): take rest replicas by fraction part</span>
<a href="#__codelineno-47-24" id="__codelineno-47-24" name="__codelineno-47-24"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-47-25" id="__codelineno-47-25" name="__codelineno-47-25"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">remain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{(</span><span class="nx">image</span><span class="p">(</span><span class="nx">images</span>
<a href="#__codelineno-47-26" id="__codelineno-47-26" name="__codelineno-47-26"></a><span class="w">            </span><span class="k">break</span>
<a href="#__codelineno-47-27" id="__codelineno-47-27" name="__codelineno-47-27"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-47-28" id="__codelineno-47-28" name="__codelineno-47-28"></a><span class="w">        </span><span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Replicas</span><span class="o">++</span>
<a href="#__codelineno-47-29" id="__codelineno-47-29" name="__codelineno-47-29"></a><span class="w">        </span><span class="nx">remain</span><span class="o">--</span>
<a href="#__codelineno-47-30" id="__codelineno-47-30" name="__codelineno-47-30"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-47-31" id="__codelineno-47-31" name="__codelineno-47-31"></a>
<a href="#__codelineno-47-32" id="__codelineno-47-32" name="__codelineno-47-32"></a><span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">NumReplicas</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">remain</span>
<a href="#__codelineno-47-33" id="__codelineno-47-33" name="__codelineno-47-33"></a><span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">Result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">MergeTargetClusters</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span>
<a href="#__codelineno-47-34" id="__codelineno-47-34" name="__codelineno-47-34"></a><span class="p">}</span>
</code></pre></div>
<p>以下为故障恢复时，截取调度器部分日志，可以清晰看到整个集群筛选和副本计算的过程。
集群 member1 由于没有容忍污点被过滤掉，集群 member3 没有被集群亲和性选中被过滤掉，最终调度结果为集群 member2，调度副本为 3。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-48-1" id="__codelineno-48-1" name="__codelineno-48-1"></a>I0217 06:46:53.057843       1 scheduler.go:390] Reschedule ResourceBinding(default/nginx-deployment) as replicas scaled down or scaled up
<a href="#__codelineno-48-2" id="__codelineno-48-2" name="__codelineno-48-2"></a>I0217 06:46:53.057888       1 scheduler.go:473] "Begin scheduling resource binding" resourceBinding="default/nginx-deployment"
<a href="#__codelineno-48-3" id="__codelineno-48-3" name="__codelineno-48-3"></a>I0217 06:46:53.083460       1 generic_scheduler.go:119] cluster "member3" is not fit, reason: cluster(s) didn't match the placement cluster affinity constraint
<a href="#__codelineno-48-4" id="__codelineno-48-4" name="__codelineno-48-4"></a>I0217 06:46:53.083524       1 generic_scheduler.go:119] cluster "member1" is not fit, reason: cluster(s) had untolerated taint {cluster.karmada.io/not-ready: }
<a href="#__codelineno-48-5" id="__codelineno-48-5" name="__codelineno-48-5"></a>I0217 06:46:53.083542       1 generic_scheduler.go:73] feasible clusters found: [member2]
<a href="#__codelineno-48-6" id="__codelineno-48-6" name="__codelineno-48-6"></a>I0217 06:46:53.083567       1 generic_scheduler.go:146] Plugin ClusterLocality scores on default/nginx =&gt; [{member2 100}]
<a href="#__codelineno-48-7" id="__codelineno-48-7" name="__codelineno-48-7"></a>I0217 06:46:53.083590       1 generic_scheduler.go:146] Plugin ClusterAffinity scores on default/nginx =&gt; [{member2 0}]
<a href="#__codelineno-48-8" id="__codelineno-48-8" name="__codelineno-48-8"></a>I0217 06:46:53.083601       1 generic_scheduler.go:79] feasible clusters scores: [{member2 100}]
<a href="#__codelineno-48-9" id="__codelineno-48-9" name="__codelineno-48-9"></a>I0217 06:46:53.085488       1 util.go:72] Target cluster: [{member2 99}]
<a href="#__codelineno-48-10" id="__codelineno-48-10" name="__codelineno-48-10"></a>I0217 06:46:53.085532       1 select_clusters.go:19] select all clusters
<a href="#__codelineno-48-11" id="__codelineno-48-11" name="__codelineno-48-11"></a>I0217 06:46:53.085548       1 generic_scheduler.go:85] selected clusters: [member2]
<a href="#__codelineno-48-12" id="__codelineno-48-12" name="__codelineno-48-12"></a>I0217 06:46:53.085571       1 scheduler.go:489] ResourceBinding default/nginx-deployment scheduled to clusters [{member2 3}]
<a href="#__codelineno-48-13" id="__codelineno-48-13" name="__codelineno-48-13"></a>I0217 06:46:53.151403       1 scheduler.go:491] "End scheduling resource binding" resourceBinding="default/nginx-deployment"
</code></pre></div>
<h3 id="gracefuleviction-controller">gracefulEviction controller<a class="headerlink" href="#gracefuleviction-controller" title="Permanent link">¶</a></h3>
<p><img alt="gracefulEviction controller" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada09.png"/></p>
<p>gracefulEviction controller 感知带有 rb.spec.gracefulEvictionTasks 的 rb(ResourceBinding) 资源的变更，
即只关心需要优雅驱逐的 rb (ResourceBinding)。然后根据调度目标集群，获取到调度结果集群的资源健康状态，
如果调度目标集群所有资源健康，则认为不需要保留优雅驱逐任务，从而移除驱逐集群任务，也就是将集群 member1
上的优雅驱逐任务移除。从中我们可以发现，优雅驱逐实现的逻辑是，保证了新的副本在符合要求的集群上 Ready 后，
再移除优雅驱逐任务，也就是才能删除调度到故障集群的旧资源。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-49-1" id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="c1">// assessEvictionTasks assesses each task according to graceful eviction rules and</span>
<a href="#__codelineno-49-2" id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="c1">// returns the tasks that should be kept.</span>
<a href="#__codelineno-49-3" id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="kd">func</span><span class="w"> </span><span class="nx">assessEvictionTasks</span><span class="p">(</span><span class="nx">bindingSpec</span><span class="w"> </span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">ResourceBindingSpec</span><span class="p">,</span>
<a href="#__codelineno-49-4" id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w">    </span><span class="nx">obse</span><span class="p">(</span><span class="nx">images</span><span class="p">[]</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">AggregatedStatusItem</span><span class="p">,</span>
<a href="#__codelineno-49-5" id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">    </span><span class="nx">timeout</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
<a href="#__codelineno-49-6" id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w">    </span><span class="nx">now</span><span class="w"> </span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span>
<a href="#__codelineno-49-7" id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">GracefulEvictionTask</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-49-8" id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">keptTasks</span><span class="w"> </span><span class="p">[]</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">GracefulEvictionTask</span>
<a href="#__codelineno-49-9" id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">evictedClusters</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span>
<a href="#__codelineno-49-10" id="__codelineno-49-10" name="__codelineno-49-10"></a>
<a href="#__codelineno-49-11" id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">GracefulEvictionTasks</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-49-12" id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">        </span><span class="c1">// set creation timestamp for new task</span>
<a href="#__codelineno-49-13" id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">CreationTimestamp</span><span class="p">.</span><span class="nx">IsZero</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-49-14" id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">            </span><span class="nx">task</span><span class="p">.</span><span class="nx">CreationTimestamp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">now</span>
<a href="#__codelineno-49-15" id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="w">            </span><span class="nx">keptTasks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">keptTasks</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="p">)</span>
<a href="#__codelineno-49-16" id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w">            </span><span class="k">continue</span>
<a href="#__codelineno-49-17" id="__codelineno-49-17" name="__codelineno-49-17"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-49-18" id="__codelineno-49-18" name="__codelineno-49-18"></a>
<a href="#__codelineno-49-19" id="__codelineno-49-19" name="__codelineno-49-19"></a><span class="w">        </span><span class="c1">// assess task according to observed status</span>
<a href="#__codelineno-49-20" id="__codelineno-49-20" name="__codelineno-49-20"></a><span class="w">        </span><span class="nx">kt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">assessSingleTask</span><span class="p">(</span><span class="nx">task</span><span class="p">,</span><span class="w"> </span><span class="nx">assessmentOption</span><span class="p">{</span>
<a href="#__codelineno-49-21" id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="w">            </span><span class="nx">scheduleResult</span><span class="p">:</span><span class="w"> </span><span class="nx">bindingSpec</span><span class="p">.</span><span class="nx">Clusters</span><span class="p">,</span>
<a href="#__codelineno-49-22" id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="w">            </span><span class="nx">timeout</span><span class="p">:</span><span class="w">        </span><span class="nx">timeout</span><span class="p">,</span>
<a href="#__codelineno-49-23" id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="w">            </span><span class="nx">observedStatus</span><span class="p">:</span><span class="w"> </span><span class="nx">observedStatus</span><span class="p">,</span>
<a href="#__codelineno-49-24" id="__codelineno-49-24" name="__codelineno-49-24"></a><span class="w">        </span><span class="p">})</span>
<a href="#__codelineno-49-25" id="__codelineno-49-25" name="__codelineno-49-25"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">kt</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-49-26" id="__codelineno-49-26" name="__codelineno-49-26"></a><span class="w">            </span><span class="nx">keptTasks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">keptTasks</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">kt</span><span class="p">)</span>
<a href="#__codelineno-49-27" id="__codelineno-49-27" name="__codelineno-49-27"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-49-28" id="__codelineno-49-28" name="__codelineno-49-28"></a><span class="w">            </span><span class="nx">evictedClusters</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">evictedClusters</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">FromCluster</span><span class="p">)</span>
<a href="#__codelineno-49-29" id="__codelineno-49-29" name="__codelineno-49-29"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-49-30" id="__codelineno-49-30" name="__codelineno-49-30"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-49-31" id="__codelineno-49-31" name="__codelineno-49-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">keptTasks</span><span class="p">,</span><span class="w"> </span><span class="nx">evictedClusters</span>
<a href="#__codelineno-49-32" id="__codelineno-49-32" name="__codelineno-49-32"></a><span class="p">}</span>
</code></pre></div>
<h3 id="binding-controller">binding controller<a class="headerlink" href="#binding-controller" title="Permanent link">¶</a></h3>
<p><img alt="Image" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada10.png"/></p>
<p>当 rb (ResourceBinding) 资源发生变更时，会被 binding controller 所感知。
首先会移除孤儿 work（work 用于存放经过传播策略规则后，在成员集群上需要真正创建的资源对象模板。
孤儿 work 是指，带有 rb （ReesourceBinding）资源对应标签的，但是随着 rb 的变更，work 已不是 rb 所期望的 work）。
除了 rb(ResourceBinding) 中三种属性中包含的集群，其他集群对应的执行命名空间下的 work 都会认为是孤儿 work：
第一种是 rb.spec.clusters，资源调度集群结果；第二种是 rb.spec.requiredBy，依赖应用的资源列表集群；
第三种是 rb.spec.gracefulEvictionTasks，优雅驱逐任务中的集群。在 gracefulEviction controller 中，
我们知道，需要新调度集群资源 Ready 后，任务才能被删除。这里就很巧妙，
这样就能保证新启动的副本在符合要求的集群上 Ready 之前，故障集群 work 永远不会被移除。</p>
<p>在示例中，可以发现当故障转移发生后，故障集群对应执行命名空间下仍然存在 work，理论上，
故障集群下 work 已经被判定为孤儿，为什么没有删除成功呢。进一步探究会发现，集群 member1
命名空间下的 work 的 DeletionTimestamp 不为空。没删除的原因是 work 存在 finalizer，
该 finalizer 是 binding controller 创建 work 时添加的。这里不能直接移除 work 的原因是，
需要保证在成员集群上的资源被移除后，才能移除 work。否则直接移除 work，会导致集群 member1 恢复后，
集群 member1 上的资源被保留，造成资源残留。所以，需要等待故障集群恢复后，execution controller
移除 work 对应在成员集群上的资源成功后，才能移除 finalizer，这样 work 就会被删除。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-50-1" id="__codelineno-50-1" name="__codelineno-50-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>karmada-es-member1<span class="w"> </span>get<span class="w"> </span>work<span class="w"> </span>nginx-687f7fb96f<span class="w"> </span>-oyaml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-51-1" id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="nn">...</span>
<a href="#__codelineno-51-2" id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">work.karmada.io/v1alpha1</span>
<a href="#__codelineno-51-3" id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Work</span>
<a href="#__codelineno-51-4" id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a href="#__codelineno-51-5" id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a href="#__codelineno-51-6" id="__codelineno-51-6" name="__codelineno-51-6"></a><span class="w">    </span><span class="nt">resourcebinding.karmada.io/name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-deployment</span>
<a href="#__codelineno-51-7" id="__codelineno-51-7" name="__codelineno-51-7"></a><span class="w">    </span><span class="nt">resourcebinding.karmada.io/namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a href="#__codelineno-51-8" id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s">"2023-02-17T08:53:08Z"</span>
<a href="#__codelineno-51-9" id="__codelineno-51-9" name="__codelineno-51-9"></a><span class="w">  </span><span class="nt">deletionGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<a href="#__codelineno-51-10" id="__codelineno-51-10" name="__codelineno-51-10"></a><span class="w">  </span><span class="nt">deletionTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s">"2023-02-17T08:55:39Z"</span>
<a href="#__codelineno-51-11" id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="w">  </span><span class="nt">finalizers</span><span class="p">:</span>
<a href="#__codelineno-51-12" id="__codelineno-51-12" name="__codelineno-51-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">karmada.io/execution-controller</span>
<a href="#__codelineno-51-13" id="__codelineno-51-13" name="__codelineno-51-13"></a><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a href="#__codelineno-51-14" id="__codelineno-51-14" name="__codelineno-51-14"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a href="#__codelineno-51-15" id="__codelineno-51-15" name="__codelineno-51-15"></a><span class="w">    </span><span class="nt">resourcebinding.karmada.io/key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">687f7fb96f</span>
<a href="#__codelineno-51-16" id="__codelineno-51-16" name="__codelineno-51-16"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-687f7fb96f</span>
<a href="#__codelineno-51-17" id="__codelineno-51-17" name="__codelineno-51-17"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">karmada-es-member1</span>
<a href="#__codelineno-51-18" id="__codelineno-51-18" name="__codelineno-51-18"></a><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s">"28134"</span>
<a href="#__codelineno-51-19" id="__codelineno-51-19" name="__codelineno-51-19"></a><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d215a03c-522d-4a89-9c5d-e87e27338a03</span>
<a href="#__codelineno-51-20" id="__codelineno-51-20" name="__codelineno-51-20"></a><span class="nn">...</span>
</code></pre></div>
<p>以下为 binding controller 的核心代码，核心逻辑是:</p>
<ul>
<li>移除孤儿 work；</li>
<li>确保 rb (ResourceBinding) 期望 work 符合预期；</li>
<li>聚合 work 的状态，记录到 rb (ResourceBinding) 的状态中；</li>
<li>根据 rb (ResourceBinding) 的聚合状态，更新 resource template 状态，
  resource template 是指存放在 Karmada 控制平面上的资源模板对象。</li>
</ul>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-52-1" id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="c1">// syncBinding will sync resourceBinding to Works.</span>
<a href="#__codelineno-52-2" id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">ResourceBindingController</span><span class="p">)</span><span class="w"> </span><span class="nx">syncBinding</span><span class="p">(</span><span class="nx">binding</span><span class="w"> </span><span class="o">*</span><span class="nx">workv1alpha2</span><span class="p">.</span><span class="nx">ResourceBinding</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-3" id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">removeOrphanWorks</span><span class="p">(</span><span class="nx">binding</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-4" id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-52-5" id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-52-6" id="__codelineno-52-6" name="__codelineno-52-6"></a>
<a href="#__codelineno-52-7" id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="w">    </span><span class="nx">workload</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">helper</span><span class="p">.</span><span class="nx">FetchWorkload</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">DynamicClient</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">InformerManager</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">RESTMapper</span><span class="p">,</span><span class="w"> </span><span class="nx">binding</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Resource</span><span class="p">)</span>
<a href="#__codelineno-52-8" id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-9" id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">apierrors</span><span class="p">.</span><span class="nx">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-10" id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="w">            </span><span class="c1">// It might happen when the resource template has been removed but the garbage collector hasn't removed</span>
<a href="#__codelineno-52-11" id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="w">            </span><span class="c1">// the ResourceBinding which dependent on resource template.</span>
<a href="#__codelineno-52-12" id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="w">            </span><span class="c1">// So, just return without retry(requeue) would save unnecessary loop.</span>
<a href="#__codelineno-52-13" id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
<a href="#__codelineno-52-14" id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-52-15" id="__codelineno-52-15" name="__codelineno-52-15"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"Failed to fetch workload for resourceBinding(%s/%s). Error: %v."</span><span class="p">,</span>
<a href="#__codelineno-52-16" id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="w">            </span><span class="nx">binding</span><span class="p">.</span><span class="nx">GetNamespace</span><span class="p">(),</span><span class="w"> </span><span class="nx">binding</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-52-17" id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-52-18" id="__codelineno-52-18" name="__codelineno-52-18"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-52-19" id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">errs</span><span class="w"> </span><span class="p">[]</span><span class="kt">error</span>
<a href="#__codelineno-52-20" id="__codelineno-52-20" name="__codelineno-52-20"></a><span class="w">    </span><span class="nx">start</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
<a href="#__codelineno-52-21" id="__codelineno-52-21" name="__codelineno-52-21"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ensureWork</span><span class="p">(</span><span class="nx">c</span><span class="p">.(</span><span class="nx">imagesesourceInterpreter</span><span class="p">,</span><span class="w"> </span><span class="nx">workload</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">OverrideManager</span><span class="p">,</span><span class="w"> </span><span class="nx">binding</span><span class="p">,</span><span class="w"> </span><span class="nx">apiextensionsv1</span><span class="p">.</span><span class="nx">NamespaceScoped</span><span class="p">)</span>
<a href="#__codelineno-52-22" id="__codelineno-52-22" name="__codelineno-52-22"></a><span class="w">    </span><span class="nx">metrics</span><span class="p">.</span><span class="nx">ObserveSyncWorkLatency</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">)</span>
<a href="#__codelineno-52-23" id="__codelineno-52-23" name="__codelineno-52-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-24" id="__codelineno-52-24" name="__codelineno-52-24"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"Failed to transform resourceBinding(%s/%s) to works. Error: %v."</span><span class="p">,</span>
<a href="#__codelineno-52-25" id="__codelineno-52-25" name="__codelineno-52-25"></a><span class="w">            </span><span class="nx">binding</span><span class="p">.</span><span class="nx">GetNamespace</span><span class="p">(),</span><span class="w"> </span><span class="nx">binding</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-52-26" id="__codelineno-52-26" name="__codelineno-52-26"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="nx">binding</span><span class="p">,</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span><span class="w"> </span><span class="nx">events</span><span class="p">.</span><span class="nx">EventReasonSyncWorkFailed</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
<a href="#__codelineno-52-27" id="__codelineno-52-27" name="__codelineno-52-27"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="nx">workload</span><span class="p">,</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span><span class="w"> </span><span class="nx">events</span><span class="p">.</span><span class="nx">EventReasonSyncWorkFailed</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">())</span>
<a href="#__codelineno-52-28" id="__codelineno-52-28" name="__codelineno-52-28"></a><span class="w">        </span><span class="nx">errs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">errs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-52-29" id="__codelineno-52-29" name="__codelineno-52-29"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-30" id="__codelineno-52-30" name="__codelineno-52-30"></a><span class="w">        </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">"Sync work of resourceBinding(%s/%s) successful."</span><span class="p">,</span><span class="w"> </span><span class="nx">binding</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">binding</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<a href="#__codelineno-52-31" id="__codelineno-52-31" name="__codelineno-52-31"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">Infof</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
<a href="#__codelineno-52-32" id="__codelineno-52-32" name="__codelineno-52-32"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="nx">binding</span><span class="p">,</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">EventTypeNormal</span><span class="p">,</span><span class="w"> </span><span class="nx">events</span><span class="p">.</span><span class="nx">EventReasonSyncWorkSucceed</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span>
<a href="#__codelineno-52-33" id="__codelineno-52-33" name="__codelineno-52-33"></a><span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="nx">workload</span><span class="p">,</span><span class="w"> </span><span class="nx">corev1</span><span class="p">.</span><span class="nx">EventTypeNormal</span><span class="p">,</span><span class="w"> </span><span class="nx">events</span><span class="p">.</span><span class="nx">EventReasonSyncWorkSucceed</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span>
<a href="#__codelineno-52-34" id="__codelineno-52-34" name="__codelineno-52-34"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-52-35" id="__codelineno-52-35" name="__codelineno-52-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">helper</span><span class="p">.</span><span class="nx">AggregateResourceBindingWorkStatus</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="nx">binding</span><span class="p">,</span><span class="w"> </span><span class="nx">workload</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">EventRecorder</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-36" id="__codelineno-52-36" name="__codelineno-52-36"></a><span class="w">        </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"Failed to aggregate workStatuses to resourceBinding(%s/%s). Error: %v."</span><span class="p">,</span>
<a href="#__codelineno-52-37" id="__codelineno-52-37" name="__codelineno-52-37"></a><span class="w">            </span><span class="nx">binding</span><span class="p">.</span><span class="nx">GetNamespace</span><span class="p">(),</span><span class="w"> </span><span class="nx">binding</span><span class="p">.</span><span class="nx">GetName</span><span class="p">(),</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-52-38" id="__codelineno-52-38" name="__codelineno-52-38"></a><span class="w">        </span><span class="nx">errs</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">errs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-52-39" id="__codelineno-52-39" name="__codelineno-52-39"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-52-40" id="__codelineno-52-40" name="__codelineno-52-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">errs</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-41" id="__codelineno-52-41" name="__codelineno-52-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">NewAggregate</span><span class="p">(</span><span class="nx">errs</span><span class="p">)</span>
<a href="#__codelineno-52-42" id="__codelineno-52-42" name="__codelineno-52-42"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-52-43" id="__codelineno-52-43" name="__codelineno-52-43"></a>
<a href="#__codelineno-52-44" id="__codelineno-52-44" name="__codelineno-52-44"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">updateResourceStatus</span><span class="p">(</span><span class="nx">binding</span><span class="p">)</span>
<a href="#__codelineno-52-45" id="__codelineno-52-45" name="__codelineno-52-45"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-52-46" id="__codelineno-52-46" name="__codelineno-52-46"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-52-47" id="__codelineno-52-47" name="__codelineno-52-47"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-52-48" id="__codelineno-52-48" name="__codelineno-52-48"></a>
<a href="#__codelineno-52-49" id="__codelineno-52-49" name="__codelineno-52-49"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
<a href="#__codelineno-52-50" id="__codelineno-52-50" name="__codelineno-52-50"></a><span class="p">}</span>
</code></pre></div>
<h3 id="execution-controller">execution controller<a class="headerlink" href="#execution-controller" title="Permanent link">¶</a></h3>
<p><img alt="execution controller" src="https://docs.daocloud.io/daocloud-docs-images/docs/blogs/images/karmada11.png"/></p>
<p>execution controller 的能力是 <strong>将成员集群对应执行命名空间的 work 中存放的实际需要下发的资源在对应成员集群创建、更新或删除。</strong>
所以，它的执行逻辑是和 work 的状态和集群的状态是息息相关的。如果 work 的 DeletionTimestamp 不为空，也就是 work 已经被删除，
则会继续判断集群状态，如果集群状态为 Ready，则会尝试删除成员集群上的资源。示例中，当集群发生故障后，资源转移到集群 member2
上所有副本都 Ready ，此时 gracefulEviction controller 会移除集群 member1 优雅驱逐任务，binding controller 认为
member1 上的 work 是孤儿，所以会删除 work。此时集群 member1 执行命名空间下的 work DeletionTimestamp 不为空，
同时集群 Not Ready，所以会进入 cluster.DeletionTimestamp.IsZero() 的判断分支，从而重新入队列，work finalizer
不会被移除，所以示例中 work 一直存在。当集群恢复后，则会进入 util.IsClusterReady(&amp;cluster.Status) 分支，
此时会尝试删除成员集群上 work 对应的资源，删除成功后，执行 removeFinalizer，将 work 上的 finalizer 移除，
这样 work 就会被删除。所以示例中集群恢复后，集群 member1 执行命名空间下的 work 和成员集群上的 deployment 都被移除了。</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-53-1" id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">work</span><span class="p">.</span><span class="nx">DeletionTimestamp</span><span class="p">.</span><span class="nx">IsZero</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-53-2" id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="w">    </span><span class="c1">// Abort deleting workload if cluster is unready when unjoining cluster, otherwise the unjoin process will be failed.</span>
<a href="#__codelineno-53-3" id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">util</span><span class="p">.</span><span class="nx">IsClusterReady</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-53-4" id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">tryDeleteWorkload</span><span class="p">(</span><span class="nx">clusterName</span><span class="p">,</span><span class="w"> </span><span class="nx">work</span><span class="p">)</span>
<a href="#__codelineno-53-5" id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<a href="#__codelineno-53-6" id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="w">            </span><span class="nx">klog</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"Failed to delete work %v, namespace is %v, err is %v"</span><span class="p">,</span><span class="w"> </span><span class="nx">work</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="nx">work</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<a href="#__codelineno-53-7" id="__codelineno-53-7" name="__codelineno-53-7"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="nx">err</span>
<a href="#__codelineno-53-8" id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-53-9" id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">DeletionTimestamp</span><span class="p">.</span><span class="nx">IsZero</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// cluster is unready, but not terminating</span>
<a href="#__codelineno-53-10" id="__codelineno-53-10" name="__codelineno-53-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">controllerruntime</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">},</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">"cluster(%s) not ready"</span><span class="p">,</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<a href="#__codelineno-53-11" id="__codelineno-53-11" name="__codelineno-53-11"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-53-12" id="__codelineno-53-12" name="__codelineno-53-12"></a>
<a href="#__codelineno-53-13" id="__codelineno-53-13" name="__codelineno-53-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">removeFinalizer</span><span class="p">(</span><span class="nx">work</span><span class="p">)</span>
<a href="#__codelineno-53-14" id="__codelineno-53-14" name="__codelineno-53-14"></a><span class="p">}</span>
</code></pre></div>
<p>以上就是 Karmada 实现故障恢复的原理，从中可以看出，它是**由多个控制器和调度器协同完成的** 。
如果其中一个控制器或调度器出问题，那么都会影响故障恢复的功能。笔者曾经提过一个故障转移不符合预期的 issue 2769，
最终发现是由于资源状态计算错误引起的，详细的修改见 pull request 2928。这就是由于在故障转移过程中，
开启了优雅驱逐，优雅驱逐会获取调度目标集群上的资源健康状态，计算是否都是 Healthy，如果都是 Healthy
则会移除优雅驱逐任务，但是由于状态计算错误，导致实际转移的目标集群上资源都是 Healthy，但是优雅驱逐控制器计算为
Healthy，所以导致优雅驱逐任务一直保留，从而出现 issue 中问题。再如 issue 2989 中，提到 work 状态仍然为
Healthy，这是由于成员集群状态为 Not Ready，从而导致 execution controller 在更新 work 状态前就重新入队列，
所以 work 状态中仍然是正确的，但是此时 work 的 DeletionTimestamp 不为空。</p>
<h2 id="_2">总结<a class="headerlink" href="#_2" title="Permanent link">¶</a></h2>
<p>当前版本的 Karmada 可以实现副本拆分策略和全量策略，但是在真正的业务场景中，例如有状态应用如何实现故障转移？
转移后如何保证应用的网络和存储？这个有待进一步实际操作验证，需要根据实际情况具体问题具体分析。</p>
<p>同时，笔者在同客户交流过程中，有客户提到，集群故障恢复后，是否可以进行重调度，将副本调度回到恢复的集群。
目前，在参与社区会议中提到这一点，目前社区的方向是，将来可能会提供给客户选择是否重调度的能力。
也就是说，将来的 Karmada 版本**可能会支持用户自定义是否要调度回恢复的集群** 。
目前没有调度回原集群的原因是，考虑到重调度对应用稳定性的影响。
同时，目前在最新的社区会议中，有讨论 <strong>增强 Failover 的 feature，会在传播策略中增加 Failover 更多配置能力</strong> ，
具体的讨论这里就不展开了，我们一起期待。</p>
<p>综上所述，<strong>基于 Karmada 应用可以实现集群级别的高可用。</strong>
随时多云的发展，Karmada 被越来越多的人所使用，我们相信，Karmada 会在越来越多的场景中解决实际问题。
在笔者参与贡献的 CNCF 项目贡献中，目前，Karmada 是 issue 回复最快，代码合并请求处理最快的项目，
这得益于社区主导者良好的代码贡献管理机制。所以，基于增长的使用用户，
社区快速的响应，我相信，Karmada 将会带给我们越来越多惊艳的能力。</p>
<h2 id="_3">参考资料<a class="headerlink" href="#_3" title="Permanent link">¶</a></h2>
<ul>
<li><a href="https://github.com/karmada-io/karmada">Karmada 源码</a></li>
<li><a href="https://karmada.io/docs/">Karmada 官方文档</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA5NTUxNzE4MQ==&amp;mid=2659273869&amp;idx=1&amp;sn=f6e03df6f34aa6106972193dba1604d8&amp;chksm=8bcbcc1fbcbc4509060f92b3d636c28c6ccaad62fa3aeb4da9f17971b06e655d1d1385ab2f2c&amp;scene=21#wechat_redirect">云原生多云应用利器 -- Karmada 总览篇</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA5NTUxNzE4MQ==&amp;mid=2659273922&amp;idx=1&amp;sn=f17630589507999fc0690741c22178b9&amp;scene=21#wechat_redirect">云原生多云应用利器 -- Karmada 控制器</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzA5NTUxNzE4MQ==&amp;mid=2659273971&amp;idx=1&amp;sn=2c81b1959c101573b5b185c342495f30&amp;chksm=8bcbcc61bcbc45772270811a23c210e3faa156078e991f56a288bd58be4246e9572badfb1fbc&amp;scene=21&amp;cur_album_id=2687691821095059459#wechat_redirect">云原生多云应用利器 -- Karmada 调度器</a></li>
</ul>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="最后更新">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年8月20日</span>
</span>
</aside>
<h2 id="__comments">评论</h2>
<!-- Insert generated snippet here -->
<script async="" crossorigin="anonymous" data-category="Announcements" data-category-id="DIC_kwDOArnAQs4CRCpV" data-emit-metadata="0" data-input-position="top" data-lang="zh-CN" data-loading="lazy" data-mapping="pathname" data-reactions-enabled="1" data-repo="daocloud/daocloud-docs" data-repo-id="MDEwOlJlcG9zaXRvcnk0NTcyNzgxMA==" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js">
</script>
<!-- Synchronize Giscus theme with palette -->
<script>
  var giscus = document.querySelector("script[src*=giscus]")

  /* Set palette on initial load */
  var palette = __md_get("__palette")
  if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light"
    giscus.setAttribute("data-theme", theme) 
  }

  /* Register event handlers after documented loaded */
  document.addEventListener("DOMContentLoaded", function() {
    var ref = document.querySelector("[data-md-component=palette]")
    ref.addEventListener("change", function() {
      var palette = __md_get("__palette")
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"

        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame")
        frame.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          "https://giscus.app"
        )
      }
    })
  })
</script>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  回到页面顶部
</button>
</main>
<footer class="md-footer">
<nav aria-label="页脚" class="md-footer__inner md-grid">
<a aria-label="上一页: 云原生监控之基础篇" class="md-footer__link md-footer__link--prev" href="230427-victoriametrics.html">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                上一页
              </span>
<div class="md-ellipsis">
                云原生监控之基础篇
              </div>
</div>
</a>
<a aria-label="下一页: CNCF 平台工程白皮书" class="md-footer__link md-footer__link--next" href="230417-cncf-platform-wp.html">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一页
              </span>
<div class="md-ellipsis">
                CNCF 平台工程白皮书
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2016 - 2024 DaoCloud
    </div>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "navigation.tabs", "navigation.prune", "navigation.sections", "navigation.tabs.sticky", "navigation.tracking", "navigation.top", "search.highlight", "search.suggest", "search.share", "toc.follow", "navigation.path", "navigation.footer"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../assets/javascripts/bundle.88dd0f4e.min.js"></script>
<script src="../stylesheets/zoom_image.js"></script>
<script src="../overrides/assets/javascripts/bundle.b97a6647.min.js"></script>
<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6b117ea770a78bebf27e63b402da0c4e";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
<script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.2.0/+esm'
    </script>
<script src="https://console.d.run/drun-copilot/chatbot-sdk.umd.js?ws=302&amp;token=ZjgxNzgwNTktMmZjNS00NTZhLWI0YTItNzYyMzQ4MDE1MzFh"></script>
<script>document$.subscribe(() => {
            window.update_swagger_ui_iframe_height = function (id) {
                var iFrameID = document.getElementById(id);
                if (iFrameID) {
                    full_height = (iFrameID.contentWindow.document.body.scrollHeight + 80) + "px";
                    iFrameID.height = full_height;
                    iFrameID.style.height = full_height;
                }
            }
        
            let iframe_id_list = []
            var iframes = document.getElementsByClassName("swagger-ui-iframe");
            for (var i = 0; i < iframes.length; i++) { 
                iframe_id_list.push(iframes[i].getAttribute("id"))
            }
        
            let ticking = true;
            
            document.addEventListener('scroll', function(e) {
                if (!ticking) {
                    window.requestAnimationFrame(()=> {
                        let half_vh = window.innerHeight/2;
                        for(var i = 0; i < iframe_id_list.length; i++) {
                            let element = document.getElementById(iframe_id_list[i])
                            if(element==null){
                                return
                            }
                            let diff = element.getBoundingClientRect().top
                            if(element.contentWindow.update_top_val){
                                element.contentWindow.update_top_val(half_vh - diff)
                            }
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        
            const dark_scheme_name = "slate"
            
            window.scheme = document.body.getAttribute("data-md-color-scheme")
            const options = {
                attributeFilter: ['data-md-color-scheme'],
            };
            function color_scheme_callback(mutations) {
                for (let mutation of mutations) {
                    if (mutation.attributeName === "data-md-color-scheme") {
                        scheme = document.body.getAttribute("data-md-color-scheme")
                        var iframe_list = document.getElementsByClassName("swagger-ui-iframe")
                        for(var i = 0; i < iframe_list.length; i++) {
                            var ele = iframe_list.item(i);
                            if (ele) {
                                if (scheme === dark_scheme_name) {
                                    ele.contentWindow.enable_dark_mode();
                                } else {
                                    ele.contentWindow.disable_dark_mode();
                                }
                            }
                        }
                    }
                }
            }
            observer = new MutationObserver(color_scheme_callback);
            observer.observe(document.body, options);
            })</script></body>
</html>